# AutoMoneyç³»ç»Ÿæ¶æ„é—®é¢˜è¯Šæ–­ä¸ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸš¨ æ ¸å¿ƒé—®é¢˜å‘ç°

### é—®é¢˜ç°è±¡
åŠ¨é‡ç­–ç•¥å®ä¾‹åœ¨å®šæ—¶æ‰§è¡Œæ—¶,ä»ç„¶æ˜¾ç¤ºæ—§çš„3ä¸ªAgent(Macro Scout/Chain Guardian/Momentum Scout),è€Œä¸æ˜¯åº”è¯¥çš„2ä¸ªæ–°Agent(Regime Filter/Momentum TA)ã€‚

### æ ¹æœ¬åŸå› 
**è°ƒåº¦å™¨(Scheduler)åœ¨æ‰¹é‡æ‰§è¡Œæ—¶ç¡¬ç¼–ç äº†`RealAgentExecutor`**,å®Œå…¨å¿½ç•¥äº†ç­–ç•¥å®šä¹‰çš„`business_agents`é…ç½®!

---

## ğŸ” ç³»ç»Ÿæ¶æ„å®Œæ•´åˆ†æ

### å½“å‰ç³»ç»Ÿæ‰§è¡Œè·¯å¾„

#### è·¯å¾„1: æ‰‹åŠ¨è§¦å‘ (å·²ä¿®å¤) âœ…
```
ç”¨æˆ·ç‚¹å‡»"Execute Now"
  â†“
API: /api/v1/strategy/manual-trigger
  â†“
æ”¶é›†å¸‚åœºæ•°æ®
  â†“
strategy_orchestrator.execute_strategy(agent_outputs=None)  âœ… ä¼ None
  â†“
orchestratoræ£€æµ‹åˆ°agent_outputs=None
  â†“
è¯»å–strategy_definition.business_agents: ['regime_filter', 'ta_momentum']
  â†“
dynamic_agent_executor.execute_agents(['regime_filter', 'ta_momentum'])  âœ…
  â†“
æ‰§è¡Œæ­£ç¡®çš„Agent
  â†“
ä¿å­˜Agentæ‰§è¡Œè®°å½•
  â†“
UIæ˜¾ç¤º: Regime Filter + Momentum TA âœ…
```

#### è·¯å¾„2: å®šæ—¶è°ƒåº¦ (æœ‰é—®é¢˜) âŒ
```
è°ƒåº¦å™¨å®šæ—¶è§¦å‘
  â†“
scheduler.batch_execute_by_template(definition_id)
  â†“
è·å–è¯¥æ¨¡æ¿çš„æ‰€æœ‰Portfolioå®ä¾‹
  â†“
âŒ ç¡¬ç¼–ç : RealAgentExecutor().execute_all_agents()
  â†“
âŒ æ€»æ˜¯æ‰§è¡Œ: macro/ta/onchain (æ—§3ä¸ªAgent)
  â†“
ä¼ é€’é”™è¯¯çš„agent_outputsç»™orchestrator
  â†“
orchestrator.execute_strategy(agent_outputs=æ—§Agentç»“æœ)  âŒ
  â†“
orchestratoræ£€æµ‹åˆ°agent_outputså·²å­˜åœ¨,è·³è¿‡åŠ¨æ€æ‰§è¡Œ
  â†“
ä½¿ç”¨é”™è¯¯çš„Agentç»“æœè¿›è¡Œå†³ç­–
  â†“
ä¿å­˜é”™è¯¯çš„Agentæ‰§è¡Œè®°å½•
  â†“
UIæ˜¾ç¤º: Macro Scout + Chain Guardian + Momentum Scout âŒ
```

---

## ğŸ“‹ é—®é¢˜ä»£ç å®šä½

### é—®é¢˜1: Schedulerç¡¬ç¼–ç Agentæ‰§è¡Œ

**æ–‡ä»¶**: `AMbackend/app/services/strategy/scheduler.py` ç¬¬392-401è¡Œ

```python
# 4. æ‰§è¡Œä¸€æ¬¡Agentåˆ†æï¼ˆæ‰€æœ‰å®ä¾‹å…±äº«ï¼‰
logger.info(f"æ‰§è¡ŒAgentåˆ†æï¼ˆ{len(portfolios)} ä¸ªå®ä¾‹å…±äº«ï¼‰")

from app.services.strategy.real_agent_executor import RealAgentExecutor
agent_executor = RealAgentExecutor()  # âŒ ç¡¬ç¼–ç æ—§çš„Executor

agent_outputs, agent_errors = await agent_executor.execute_all_agents(  # âŒ æ€»æ˜¯æ‰§è¡Œæ—§Agent
    market_data=market_data,
    db=db,
    user_id=portfolios[0].user_id,
    strategy_execution_id=None,
    template_execution_batch_id=batch_id,
)
```

**é—®é¢˜**:
1. ç¡¬ç¼–ç ä½¿ç”¨`RealAgentExecutor`
2. è°ƒç”¨`execute_all_agents()`æ€»æ˜¯æ‰§è¡Œ`macro/ta/onchain`
3. å®Œå…¨å¿½ç•¥`strategy_definition.business_agents`é…ç½®

### é—®é¢˜2: æ‰¹é‡ä¼˜åŒ–è®¾è®¡å†²çª

**å½“å‰è®¾è®¡**:
```
æ‰¹é‡æ‰§è¡Œä¼˜åŒ– = å¤šä¸ªå®ä¾‹å…±äº«ä¸€æ¬¡Agentåˆ†æ
ç›®çš„: é™ä½LLMæˆæœ¬
```

**å†²çªç‚¹**:
- ä¸åŒç­–ç•¥æ¨¡æ¿ä½¿ç”¨**ä¸åŒçš„Agentç»„åˆ**
- åŠ¨é‡ç­–ç•¥éœ€è¦: `regime_filter` + `ta_momentum`
- æ—§ç­–ç•¥éœ€è¦: `macro` + `ta` + `onchain`
- **æ— æ³•ç”¨åŒä¸€ç»„Agentç»“æœæœåŠ¡ä¸¤ç§ç­–ç•¥!**

---

## ğŸ¯ ç³»ç»Ÿæ¶æ„è®¾è®¡åŸåˆ™

### æ­£ç¡®çš„æŠ½è±¡å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è°ƒåº¦å±‚ (Scheduler)                     â”‚
â”‚  èŒè´£: å®šæ—¶è§¦å‘,æ‰¹é‡ç®¡ç†                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ç¼–æ’å±‚ (Orchestrator)                    â”‚
â”‚  èŒè´£: åè°ƒæ•°æ®é‡‡é›†ã€Agentæ‰§è¡Œã€å†³ç­–ã€äº¤æ˜“                 â”‚
â”‚  æ ¸å¿ƒ: æ ¹æ®ç­–ç•¥å®šä¹‰åŠ¨æ€è°ƒåº¦Agent                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Agentæ‰§è¡Œå±‚ (AgentExecutor)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚RealAgent     â”‚  â”‚DynamicAgent  â”‚                     â”‚
â”‚  â”‚Executor      â”‚  â”‚Executor      â”‚                     â”‚
â”‚  â”‚(æ—§ç­–ç•¥ä¸“ç”¨)   â”‚  â”‚(é€šç”¨/æ–°ç­–ç•¥)  â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ä¸šåŠ¡Agentå±‚ (Agents)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚Macro â”‚ â”‚TA    â”‚ â”‚OnCh- â”‚ â”‚Regimeâ”‚ â”‚TA    â”‚         â”‚
â”‚  â”‚Agent â”‚ â”‚Agent â”‚ â”‚ain   â”‚ â”‚Filterâ”‚ â”‚Momen.â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                å†³ç­–Agentå±‚ (Decision)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚MultiAgent        â”‚  â”‚MomentumRegime    â”‚            â”‚
â”‚  â”‚ConvictionDecisionâ”‚  â”‚Decision          â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç­–ç•¥å®šä¹‰çš„å…³é”®å­—æ®µ

```python
class StrategyDefinition:
    name: str                      # ç­–ç•¥å”¯ä¸€æ ‡è¯†
    display_name: str              # æ˜¾ç¤ºåç§°
    
    # ğŸ”‘ å…³é”®: å®šä¹‰ä½¿ç”¨å“ªäº›ä¸šåŠ¡Agent
    business_agents: List[str]     # ['regime_filter', 'ta_momentum']
    
    # ğŸ”‘ å…³é”®: å®šä¹‰ä½¿ç”¨å“ªä¸ªå†³ç­–Agent
    decision_agent_module: str     # 'app.decision_agents.momentum_regime_decision'
    decision_agent_class: str      # 'MomentumRegimeDecision'
    
    rebalance_period_minutes: int  # æ‰§è¡Œå‘¨æœŸ
    default_params: Dict           # é»˜è®¤å‚æ•°
```

**è®¾è®¡æ„å›¾**:
- `business_agents`: å‘Šè¯‰ç³»ç»Ÿ"è°ƒç”¨å“ªäº›Agentåˆ†æ"
- `decision_agent_class`: å‘Šè¯‰ç³»ç»Ÿ"ç”¨å“ªä¸ªå†³ç­–å¼•æ“"
- ç­–ç•¥æ¨¡æ¿ = Agentç»„åˆ + å†³ç­–é€»è¾‘ + å‚æ•°é…ç½®

---

## âœ… å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆA: è°ƒåº¦å™¨ä½¿ç”¨åŠ¨æ€Agentæ‰§è¡Œ (æ¨è)

#### ä¿®æ”¹1: Schedulerä½¿ç”¨DynamicAgentExecutor

**æ–‡ä»¶**: `AMbackend/app/services/strategy/scheduler.py`

```python
async def batch_execute_by_template(self, definition_id: int):
    """æŒ‰ç­–ç•¥æ¨¡æ¿æ‰¹é‡æ‰§è¡Œ"""
    try:
        async with self.SessionLocal() as db:
            # 1. è·å–æŒ‡å®šæ¨¡æ¿çš„æ‰€æœ‰æ´»è·ƒPortfolio
            result = await db.execute(
                select(Portfolio)
                .options(
                    selectinload(Portfolio.holdings),
                    selectinload(Portfolio.strategy_definition)
                )
                .where(
                    Portfolio.strategy_definition_id == definition_id,
                    Portfolio.is_active == True
                )
            )
            portfolios = result.scalars().all()

            if not portfolios:
                return

            definition = portfolios[0].strategy_definition
            if not definition:
                return

            logger.info(f"æ‰§è¡Œç­–ç•¥æ¨¡æ¿: {definition.display_name}")
            logger.info(f"ä¸šåŠ¡Agent: {definition.business_agents}")

            # 2. ç”Ÿæˆæ‰¹æ¬¡ID
            import uuid
            batch_id = uuid.uuid4()

            # 3. é‡‡é›†å¸‚åœºæ•°æ®
            market_data = await self._fetch_market_data()

            # 4. ğŸ†• æ ¹æ®ç­–ç•¥å®šä¹‰åŠ¨æ€æ‰§è¡ŒAgent
            if definition.business_agents:
                # ä½¿ç”¨åŠ¨æ€Agentæ‰§è¡Œå™¨
                from app.services.strategy.dynamic_agent_executor import dynamic_agent_executor
                
                agent_outputs, agent_errors = await dynamic_agent_executor.execute_agents(
                    agent_names=definition.business_agents,  # âœ… ä»ç­–ç•¥å®šä¹‰è¯»å–
                    market_data=market_data,
                    db=db,
                    user_id=portfolios[0].user_id,
                    strategy_execution_id=None,
                    template_execution_batch_id=batch_id,
                )
                logger.info(f"âœ… åŠ¨æ€Agentæ‰§è¡Œå®Œæˆ: {list(agent_outputs.keys())}")
            else:
                # å‘åå…¼å®¹: æ—§ç­–ç•¥æ²¡æœ‰å®šä¹‰business_agents
                from app.services.strategy.real_agent_executor import RealAgentExecutor
                agent_executor = RealAgentExecutor()
                
                agent_outputs, agent_errors = await agent_executor.execute_all_agents(
                    market_data=market_data,
                    db=db,
                    user_id=portfolios[0].user_id,
                    strategy_execution_id=None,
                    template_execution_batch_id=batch_id,
                )
                logger.info(f"âœ… é»˜è®¤Agentæ‰§è¡Œå®Œæˆ (æ—§ç­–ç•¥)")

            # 5. ä¸ºæ¯ä¸ªPortfolioæ‰§è¡Œå†³ç­–å’Œäº¤æ˜“
            for portfolio in portfolios:
                try:
                    execution = await strategy_orchestrator.execute_strategy(
                        db=db,
                        user_id=portfolio.user_id,
                        portfolio_id=str(portfolio.id),
                        market_data=market_data,
                        agent_outputs=agent_outputs,  # âœ… ä½¿ç”¨æ­£ç¡®çš„Agentç»“æœ
                        template_execution_batch_id=batch_id,
                    )
                    
                    portfolio.last_execution_time = datetime.utcnow()
                    await db.commit()
                    
                except Exception as e:
                    logger.error(f"å®ä¾‹æ‰§è¡Œå¤±è´¥: {portfolio.instance_name} - {e}")
                    continue
                    
    except Exception as e:
        logger.error(f"æ‰¹é‡æ‰§è¡Œå¤±è´¥: {e}", exc_info=True)
```

**å…³é”®æ”¹åŠ¨**:
1. âœ… æ£€æŸ¥`definition.business_agents`
2. âœ… å¦‚æœæœ‰å®šä¹‰,ä½¿ç”¨`dynamic_agent_executor`
3. âœ… å¦‚æœæ²¡å®šä¹‰(æ—§ç­–ç•¥),ä½¿ç”¨`RealAgentExecutor`
4. âœ… å‘åå…¼å®¹

### æ–¹æ¡ˆB: å®Œå…¨å–æ¶ˆæ‰¹é‡ä¼˜åŒ– (å¤‡é€‰)

å¦‚æœä¸åŒç­–ç•¥çš„Agentæ‰§è¡Œæˆæœ¬å·®å¼‚å¤§,å¯ä»¥è€ƒè™‘:

```python
async def batch_execute_by_template(self, definition_id: int):
    """æŒ‰ç­–ç•¥æ¨¡æ¿æ‰¹é‡æ‰§è¡Œ"""
    try:
        async with self.SessionLocal() as db:
            # 1. è·å–æ‰€æœ‰å®ä¾‹
            portfolios = ...
            
            # 2. é‡‡é›†å¸‚åœºæ•°æ®(ä»å¯å…±äº«)
            market_data = await self._fetch_market_data()
            
            # 3. âŒ ä¸å†å…±äº«Agentæ‰§è¡Œ
            # 4. ä¸ºæ¯ä¸ªå®ä¾‹ç‹¬ç«‹æ‰§è¡Œ(åŒ…æ‹¬Agent)
            for portfolio in portfolios:
                execution = await strategy_orchestrator.execute_strategy(
                    db=db,
                    user_id=portfolio.user_id,
                    portfolio_id=str(portfolio.id),
                    market_data=market_data,
                    agent_outputs=None,  # âœ… è®©orchestratoråŠ¨æ€æ‰§è¡Œ
                    template_execution_batch_id=batch_id,
                )
```

**ä¼˜ç‚¹**:
- é€»è¾‘æœ€æ¸…æ™°
- å®Œå…¨ä¾èµ–ç­–ç•¥å®šä¹‰
- æ— éœ€è€ƒè™‘æ‰¹é‡ä¼˜åŒ–

**ç¼ºç‚¹**:
- LLMæˆæœ¬å¢åŠ (æ¯ä¸ªå®ä¾‹éƒ½è°ƒç”¨Agent)
- æ‰§è¡Œæ—¶é—´å˜é•¿

---

## ğŸ”§ ç«‹å³ä¿®å¤æ­¥éª¤

### Step 1: ä¿®å¤Scheduler (æ ¸å¿ƒ)

ä¿®æ”¹`AMbackend/app/services/strategy/scheduler.py`çš„`batch_execute_by_template`æ–¹æ³•,ä½¿ç”¨æ–¹æ¡ˆAçš„ä»£ç ã€‚

### Step 2: éªŒè¯æ—§ç­–ç•¥çš„business_agents

ç¡®ä¿æ—§ç­–ç•¥æ¨¡æ¿æœ‰æ­£ç¡®çš„`business_agents`é…ç½®:

```sql
-- æ£€æŸ¥æ‰€æœ‰ç­–ç•¥æ¨¡æ¿çš„business_agents
SELECT 
    id,
    name,
    display_name,
    business_agents,
    decision_agent_class
FROM strategy_definitions;

-- é¢„æœŸç»“æœ:
-- id | name                    | business_agents
-- ---|-------------------------|---------------------------
-- 1  | multi_agent_btc_v1      | ['macro', 'ta', 'onchain']
-- 3  | momentum_regime_btc_v1  | ['regime_filter', 'ta_momentum']
```

å¦‚æœæ—§ç­–ç•¥çš„`business_agents`ä¸ºç©ºæˆ–NULL,éœ€è¦æ›´æ–°:

```python
# AMbackend/scripts/update_old_strategy_agents.py
from app.db.session import AsyncSessionLocal
from app.models.strategy_definition import StrategyDefinition
from sqlalchemy import select
import asyncio

async def update_old_strategy():
    async with AsyncSessionLocal() as db:
        result = await db.execute(
            select(StrategyDefinition).where(
                StrategyDefinition.name == 'multi_agent_btc_v1'
            )
        )
        strategy = result.scalar_one_or_none()
        
        if strategy:
            strategy.business_agents = ['macro', 'ta', 'onchain']
            await db.commit()
            print(f"âœ… å·²æ›´æ–°æ—§ç­–ç•¥çš„business_agents")

asyncio.run(update_old_strategy())
```

### Step 3: é‡å¯æœåŠ¡å¹¶æµ‹è¯•

```bash
./stop.sh && ./start.sh
```

**éªŒè¯æ­¥éª¤**:
1. ç­‰å¾…è°ƒåº¦å™¨è‡ªåŠ¨æ‰§è¡ŒåŠ¨é‡ç­–ç•¥(15åˆ†é’Ÿå‘¨æœŸ)
2. æˆ–æ‰‹åŠ¨è§¦å‘: åœ¨Portfolioé¡µé¢ç‚¹å‡»"Execute Now"
3. æŸ¥çœ‹ç­–ç•¥è¯¦æƒ…é¡µçš„"Recent Squad Actions"
4. åº”è¯¥æ˜¾ç¤º: Regime Filter + Momentum TA (2ä¸ªAgent)
5. ä¸åº”è¯¥æ˜¾ç¤º: The Oracle / Momentum Scout / Data Warden

---

## ğŸ“Š ç³»ç»Ÿæ‰§è¡Œæµç¨‹(ä¿®å¤å)

### å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         è°ƒåº¦å™¨ (Scheduler)                  â”‚
â”‚  - å®šæ—¶è§¦å‘: æ¯15åˆ†é’Ÿ                        â”‚
â”‚  - æŒ‰ç­–ç•¥æ¨¡æ¿åˆ†ç»„æ‰§è¡Œ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     batch_execute_by_template              â”‚
â”‚  1. è·å–æ¨¡æ¿çš„æ‰€æœ‰Portfolioå®ä¾‹              â”‚
â”‚  2. è¯»å–strategy_definition.business_agents â”‚
â”‚  3. é‡‡é›†å¸‚åœºæ•°æ®(æ‰€æœ‰å®ä¾‹å…±äº«)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ—§ç­–ç•¥           â”‚    â”‚åŠ¨é‡ç­–ç•¥         â”‚
â”‚business_agents: â”‚    â”‚business_agents: â”‚
â”‚['macro',        â”‚    â”‚['regime_filter',â”‚
â”‚ 'ta',          â”‚    â”‚ 'ta_momentum']  â”‚
â”‚ 'onchain']     â”‚    â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚RealAgent       â”‚    â”‚DynamicAgent    â”‚
â”‚Executor        â”‚    â”‚Executor        â”‚
â”‚execute_all     â”‚    â”‚execute_agents  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚macro_agent     â”‚    â”‚regime_filter   â”‚
â”‚ta_agent        â”‚    â”‚ta_momentum     â”‚
â”‚onchain_agent   â”‚    â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         strategy_orchestrator              â”‚
â”‚  - æ¥æ”¶agent_outputs                        â”‚
â”‚  - åŠ è½½å†³ç­–Agent                            â”‚
â”‚  - æ‰§è¡Œå†³ç­–                                 â”‚
â”‚  - æ‰§è¡Œäº¤æ˜“                                 â”‚
â”‚  - ä¿å­˜è®°å½•                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚MultiAgent      â”‚    â”‚MomentumRegime  â”‚
â”‚Conviction      â”‚    â”‚Decision        â”‚
â”‚Decision        â”‚    â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ•°æ®åº“è®°å½•                       â”‚
â”‚  - strategy_executions                     â”‚
â”‚  - agent_executions (æ­£ç¡®çš„Agent)          â”‚
â”‚  - trades                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å‰ç«¯UI                           â”‚
â”‚  - æ—§ç­–ç•¥: æ˜¾ç¤º3ä¸ªAgent                     â”‚
â”‚  - åŠ¨é‡ç­–ç•¥: æ˜¾ç¤º2ä¸ªAgent + Regime Score   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä¼˜åŒ–å»ºè®®

### 1. é…ç½®é©±åŠ¨è®¾è®¡
**åŸåˆ™**: "é…ç½®ä¼˜äºç¡¬ç¼–ç "

æ‰€æœ‰ç­–ç•¥è¡Œä¸ºéƒ½åº”è¯¥é€šè¿‡`StrategyDefinition`é…ç½®:
- âœ… ä½¿ç”¨å“ªäº›Agent: `business_agents`
- âœ… ä½¿ç”¨å“ªä¸ªå†³ç­–å¼•æ“: `decision_agent_class`
- âœ… æ‰§è¡Œå‘¨æœŸ: `rebalance_period_minutes`
- âœ… å‚æ•°: `default_params`

### 2. ä¾èµ–æ³¨å…¥
é¿å…åœ¨Schedulerä¸­ç›´æ¥importå…·ä½“çš„Executor:

```python
class StrategyScheduler:
    def __init__(self, orchestrator, agent_executor_factory):
        self.orchestrator = orchestrator
        self.executor_factory = agent_executor_factory
```

### 3. ç­–ç•¥æ³¨å†Œæœºåˆ¶
å»ºç«‹ç­–ç•¥æ³¨å†Œè¡¨,è‡ªåŠ¨å‘ç°å’Œæ³¨å†Œç­–ç•¥:

```python
class StrategyRegistry:
    _strategies = {}
    
    @classmethod
    def register(cls, name, strategy_class):
        cls._strategies[name] = strategy_class
    
    @classmethod
    def get(cls, name):
        return cls._strategies.get(name)
```

### 4. æ‰¹é‡ä¼˜åŒ–ç­–ç•¥
- åŒä¸€æ¨¡æ¿çš„å®ä¾‹å¯ä»¥å…±äº«Agentç»“æœ
- ä½†ä¸åŒæ¨¡æ¿å¿…é¡»ç‹¬ç«‹æ‰§è¡ŒAgent
- è°ƒåº¦å™¨åº”è¯¥:
  1. æŒ‰æ¨¡æ¿åˆ†ç»„
  2. æ¯ä¸ªæ¨¡æ¿ç‹¬ç«‹æ‰§è¡ŒAgent
  3. æ¨¡æ¿å†…çš„å®ä¾‹å…±äº«ç»“æœ

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
```
è°ƒåº¦å™¨æ‰§è¡ŒåŠ¨é‡ç­–ç•¥
  â†’ ç¡¬ç¼–ç æ‰§è¡Œmacro/ta/onchain âŒ
  â†’ UIæ˜¾ç¤º3ä¸ªæ—§Agent âŒ
  â†’ å†³ç­–ä½¿ç”¨é”™è¯¯çš„Agentæ•°æ® âŒ
```

### ä¿®å¤å
```
è°ƒåº¦å™¨æ‰§è¡ŒåŠ¨é‡ç­–ç•¥
  â†’ è¯»å–business_agents: ['regime_filter', 'ta_momentum'] âœ…
  â†’ åŠ¨æ€æ‰§è¡Œæ­£ç¡®çš„Agent âœ…
  â†’ UIæ˜¾ç¤ºRegime Filter + Momentum TA âœ…
  â†’ å†³ç­–ä½¿ç”¨æ­£ç¡®çš„Agentæ•°æ® âœ…
  â†’ Regime Scoreæ˜¾ç¤º âœ…
  â†’ OCOè®¢å•ç”Ÿæˆ âœ…
```

---

## âœ… æ€»ç»“

### é—®é¢˜æ ¹æº
1. **Schedulerç¡¬ç¼–ç `RealAgentExecutor`**
2. **å¿½ç•¥`strategy_definition.business_agents`é…ç½®**
3. **æ‰¹é‡ä¼˜åŒ–è®¾è®¡æœªè€ƒè™‘ä¸åŒç­–ç•¥æ¨¡æ¿çš„Agentå·®å¼‚**

### è§£å†³æ–¹æ¡ˆ
1. âœ… Scheduleræ ¹æ®`business_agents`åŠ¨æ€é€‰æ‹©Executor
2. âœ… æœ‰é…ç½®ç”¨`DynamicAgentExecutor`,æ— é…ç½®ç”¨`RealAgentExecutor`
3. âœ… å‘åå…¼å®¹æ—§ç­–ç•¥

### æ¶æ„åŸåˆ™
1. **é…ç½®é©±åŠ¨**: ç­–ç•¥è¡Œä¸ºç”±StrategyDefinitionå®šä¹‰
2. **è§£è€¦åˆ**: Schedulerä¸åº”è¯¥çŸ¥é“å…·ä½“çš„Agentå®ç°
3. **å¯æ‰©å±•**: æ–°å¢ç­–ç•¥åªéœ€æ³¨å†Œ,æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 

---

**ä¿®å¤ä¼˜å…ˆçº§**: ğŸ”´ P0 (å½±å“æ ¸å¿ƒåŠŸèƒ½)  
**é¢„è®¡å·¥ä½œé‡**: 30åˆ†é’Ÿ  
**å½±å“èŒƒå›´**: å®šæ—¶è°ƒåº¦æ‰§è¡Œçš„æ‰€æœ‰ç­–ç•¥

