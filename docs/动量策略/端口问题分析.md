# 端口问题深层分析

## 🐛 问题描述

启动后端后,用户登录验证功能失效。

---

## 🔍 深层原因分析

### 系统设计的正确端口: **8000** ✅

#### 证据1: 后端配置
```python
# AMbackend/app/core/config.py
class Settings(BaseSettings):
    HOST: str = "0.0.0.0"
    PORT: int = 8000  # ← 默认端口8000
```

#### 证据2: 前端代理配置
```typescript
// AMfrontend/vite.config.ts
server: {
  port: 3010,
  open: true,
  proxy: {
    '/api': {
      target: 'http://localhost:8000',  // ← 前端期待后端在8000
      changeOrigin: true,
    },
  },
}
```

#### 证据3: Docker配置
```dockerfile
# AMbackend/Dockerfile.dev
EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
```

#### 证据4: 文档
```
# AMbackend/README.md
Visit http://localhost:8000/docs for API documentation.
```

---

## ❌ 错误的来源

### AI的错误判断

在当前开发session中:
1. AI运行了 `uvicorn app.main:app --port 8080` 进行测试
2. AI错误地认为8080是系统的正确端口
3. AI修改了`start.sh`和`stop.sh`使用8080
4. 这导致了端口不匹配

### 实际问题

```
前端 (vite.config.ts):
  GET /api/v1/auth/login
  → proxy to http://localhost:8000  // ← 期待8000
  
后端 (实际运行):
  uvicorn --port 8080               // ← 实际在8080
  
结果:
  前端 → 8000 (无服务) → 连接失败 ❌
  后端 → 8080 (有服务) → 前端永远找不到
```

---

## ✅ 正确的配置

### 端口分配

| 服务 | 端口 | 配置位置 |
|------|------|----------|
| 后端API | 8000 | `app/core/config.py` |
| 前端Dev | 3010 | `vite.config.ts` |
| PostgreSQL | 5432 | `docker-compose.yml` |
| Redis | 6379 | `docker-compose.yml` |

### 前后端通信

```
用户浏览器
  ↓
http://localhost:3010 (前端Vite Dev Server)
  ↓ (API请求 /api/v1/*)
Vite Proxy (vite.config.ts)
  ↓
http://localhost:8000 (后端FastAPI)
  ↓
Database / Redis / External APIs
```

---

## 🔧 已修复的文件

### 1. stop.sh ✅
```bash
# 修复前 (错误)
for PORT in 8000 8080; do
    ...
done

# 修复后 (正确)
BACKEND_PORT_PIDS=$(lsof -ti:8000 2>/dev/null)
```

### 2. start.sh ✅
```bash
# 修复前 (错误)
if check_port 8080; then
nohup uvicorn app.main:app --port 8080 ...
curl -s http://localhost:8080/health ...

# 修复后 (正确)
if check_port 8000; then
nohup uvicorn app.main:app --port 8000 ...
curl -s http://localhost:8000/health ...
```

### 3. 前端配置 (无需修改)
```typescript
// vite.config.ts - 已经是正确的
proxy: {
  '/api': {
    target: 'http://localhost:8000',  // ✅ 正确
  },
}
```

---

## 📋 验证步骤

### 1. 停止所有服务
```bash
pkill -f "uvicorn app.main:app"
lsof -ti:8000 | xargs kill -9
lsof -ti:3010 | xargs kill -9
```

### 2. 重新启动
```bash
./start.sh
```

### 3. 验证端口
```bash
# 后端应该在8000
lsof -i:8000
# 应该看到: uvicorn

# 健康检查
curl http://localhost:8000/health
# 应该返回: {"status":"healthy",...}
```

### 4. 验证登录
```bash
# 访问前端
open http://localhost:3010

# 尝试登录
# 应该能正常调用 /api/v1/auth/* 接口
```

---

## 🎓 经验教训

### 1. 不要凭临时测试判断系统配置
- ✅ **应该**: 查看配置文件和文档
- ❌ **不应该**: 根据临时测试命令推断

### 2. 前后端端口必须一致
- 前端代理配置: `proxy.target`
- 后端实际端口: `uvicorn --port`
- 两者必须匹配

### 3. 配置有多个来源
需要检查:
- 环境变量 (`.env`)
- 配置文件 (`config.py`)
- 启动脚本 (`start.sh`)
- 前端代理 (`vite.config.ts`)

### 4. 症状 vs 根因
- **症状**: 登录失效
- **根因**: 端口不匹配导致前端无法连接后端

---

## 🔄 正确的工作流程

### 开发环境启动
```bash
# 1. 初始化(首次或更新后)
./init.sh

# 2. 启动服务
./start.sh
# 后端: http://localhost:8000
# 前端: http://localhost:3010

# 3. 验证
curl http://localhost:8000/health
open http://localhost:3010
```

### 端口检查
```bash
# 查看所有监听端口
lsof -i -P | grep LISTEN

# 应该看到:
# uvicorn   ... TCP *:8000 (LISTEN)
# node      ... TCP *:3010 (LISTEN)
```

---

## ✅ 总结

### 问题
- AI错误地将端口从8000改为8080
- 导致前端代理(8000)无法连接到后端(8080)
- 登录等所有API调用失败

### 解决
- 恢复所有脚本使用8000端口
- 确保与前端vite.config.ts一致

### 验证
- [x] stop.sh 使用8000
- [x] start.sh 使用8000
- [x] vite.config.ts 使用8000 (本来就是)
- [x] 所有配置一致

---

**修复状态**: ✅ 完成  
**端口配置**: 8000 (正确)  
**测试状态**: 待验证

