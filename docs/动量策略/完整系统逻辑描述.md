# H.I.M.E. åŠ¨é‡ç­–ç•¥ - å®Œæ•´ç³»ç»Ÿé€»è¾‘æè¿°

## ğŸ” é—®é¢˜è¯Šæ–­

### å½“å‰Bug: Agentæ‰§è¡Œä¸åŒ¹é…

**é—®é¢˜**: ç³»ç»Ÿåœ¨æ‰§è¡ŒåŠ¨é‡ç­–ç•¥æ—¶,è°ƒç”¨çš„æ˜¯æ—§çš„Multi-Agent Squad (macro/ta/onchain),è€Œä¸æ˜¯åŠ¨é‡ç­–ç•¥ä¸“ç”¨çš„æ–°Agent (regime_filter/ta_momentum)ã€‚

**æ ¹æœ¬åŸå› **:
1. `StrategyOrchestrator.execute_strategy()` **ç¡¬ç¼–ç **è°ƒç”¨ `real_agent_executor.execute_all_agents()`
2. `RealAgentExecutor.execute_all_agents()` **ç¡¬ç¼–ç **æ‰§è¡Œ macro/ta/onchain ä¸‰ä¸ªAgent
3. **å®Œå…¨å¿½ç•¥** `strategy_definition.business_agents` å­—æ®µ

**é”™è¯¯ä»£ç ä½ç½®**:
```python
# strategy_orchestrator.py:163
agent_outputs, agent_errors = await real_agent_executor.execute_all_agents(
    market_data=market_data,
    db=db,
    user_id=user_id,
    strategy_execution_id=strategy_execution_id,
)
# âŒ é—®é¢˜: æ²¡æœ‰ä¼ å…¥ business_agents åˆ—è¡¨,æ€»æ˜¯æ‰§è¡Œ macro/ta/onchain
```

```python
# real_agent_executor.py:86-90
tasks = [
    self._run_agent_with_retry("macro", self._run_macro_agent, ...),
    self._run_agent_with_retry("ta", self._run_ta_agent, ...),
    self._run_agent_with_retry("onchain", self._run_onchain_agent, ...),
]
# âŒ é—®é¢˜: ç¡¬ç¼–ç çš„ä¸‰ä¸ªAgent,æ— æ³•åŠ¨æ€è°ƒæ•´
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: åˆ›å»ºåŠ¨æ€Agentæ‰§è¡Œå™¨ (æ¨è)

å‚è€ƒ `ResearchWorkflow._execute_business_agents()` çš„å®ç°,åˆ›å»ºä¸€ä¸ªé€šç”¨çš„åŠ¨æ€Agentæ‰§è¡Œå™¨ã€‚

**éœ€è¦åšçš„ä¿®æ”¹**:
1. åˆ›å»ºAgentæ³¨å†Œè¡¨ (mapping agent_name â†’ agent_instance)
2. åœ¨ `StrategyOrchestrator` ä¸­æ ¹æ® `strategy_definition.business_agents` åŠ¨æ€æ‰§è¡Œ
3. ä¿ç•™ `RealAgentExecutor` ä½œä¸ºé»˜è®¤(æ—§ç­–ç•¥å…¼å®¹)

**æ–‡ä»¶ä¿®æ”¹æ¸…å•**:
- [ ] åˆ›å»º `app/services/strategy/dynamic_agent_executor.py`
- [ ] ä¿®æ”¹ `app/services/strategy/strategy_orchestrator.py`
- [ ] åœ¨ `app/agents/__init__.py` ä¸­åˆ›å»º agent_registry

### æ–¹æ¡ˆ2: æ‰©å±•RealAgentExecutor (ç®€å•å¿«é€Ÿ)

åœ¨ `RealAgentExecutor` ä¸­æ·»åŠ æ¡ä»¶åˆ¤æ–­,æ ¹æ®Agentåç§°åŠ¨æ€è°ƒç”¨ã€‚

**ä¼˜ç‚¹**: ä¿®æ”¹æœ€å°,å¿«é€Ÿä¿®å¤  
**ç¼ºç‚¹**: ä¸å¤Ÿä¼˜é›…,æ‰©å±•æ€§å·®

---

## ğŸ“‹ å®Œæ•´ç³»ç»Ÿé€»è¾‘æè¿°

---

## 1. ç­–ç•¥å®šä¹‰ (StrategyDefinition)

### æ•°æ®åº“è®°å½•
```sql
SELECT * FROM strategy_definitions WHERE id = 3;
```

### å­—æ®µè¯¦è§£

| å­—æ®µ | å€¼ | è¯´æ˜ |
|------|-----|------|
| `id` | 3 | ç­–ç•¥æ¨¡æ¿ID |
| `name` | "momentum_regime_btc_v1" | ç­–ç•¥å”¯ä¸€æ ‡è¯†ç¬¦ |
| `display_name` | "H.I.M.E. åŠ¨é‡ç­–ç•¥" | å‰ç«¯æ˜¾ç¤ºåç§° |
| `description` | "..."  | ç­–ç•¥æè¿°(markdownæ ¼å¼) |
| `philosophy` | "æŠ€æœ¯åˆ†æä¸»å¯¼+å®è§‚ç¯å¢ƒç¡®è®¤+å¼ºåˆ¶é£æ§" | æŠ•èµ„ç†å¿µ |
| `risk_level` | "high" | é£é™©ç­‰çº§ |
| `is_active` | `true` | æ˜¯å¦æ¿€æ´» |
| **`business_agents`** | `["regime_filter", "ta_momentum"]` | âš ï¸ **å…³é”®å­—æ®µ**: æŒ‡å®šè¦æ‰§è¡Œçš„Agent |
| **`decision_agent_module`** | "app.decision_agents.momentum_regime_decision" | å†³ç­–Agentæ¨¡å—è·¯å¾„ |
| **`decision_agent_class`** | "MomentumRegimeDecision" | å†³ç­–Agentç±»å |
| `trade_channel` | "binance_spot" | äº¤æ˜“æ¸ é“ |
| `trade_symbol` | "BTC" | ä¸»äº¤æ˜“å¸ç§ |
| `rebalance_period_minutes` | 15 | æ‰§è¡Œå‘¨æœŸ(åˆ†é’Ÿ) |
| **`default_params`** | `{...}` | é»˜è®¤å‚æ•°é…ç½® |

### default_params è¯¦è§£

```json
{
  // === èµ„é‡‘ç®¡ç† ===
  "base_risk_pct": 2.0,        // å•ç¬”åŸºç¡€é£é™©(è´¦æˆ·çš„2%)
  "base_leverage": 3.0,         // åŸºç¡€æ æ†(æ¨¡æ‹Ÿäº¤æ˜“æš‚ä¸ç”Ÿæ•ˆ)
  "max_leverage": 5.0,          // æœ€å¤§æ æ†

  // === ä¿¡å·è¿‡æ»¤ ===
  "min_signal_strength": 0.6,   // æœ€ä½ä¿¡å·å¼ºåº¦(0-1)
  "min_confidence": 0.5,        // æœ€ä½ä¿¡å¿ƒæ°´å¹³(0-1)

  // === Regime è°ƒåˆ¶===
  "regime_weight": 0.2,         // Regimeå½±å“æƒé‡(20%)
  "ta_weight": 0.8,             // TAå½±å“æƒé‡(80%)
  "regime_threshold_dangerous": 25.0,  // å±é™©é˜ˆå€¼(æ‹’ç»é€†åŠ¿)
  "regime_threshold_healthy": 60.0,    // å¥åº·é˜ˆå€¼

  // === æ­¢æŸæ­¢ç›ˆ ===
  "default_tp_rr": 2.0,         // é»˜è®¤æ­¢ç›ˆé£é™©å›æŠ¥æ¯”
  "min_tp_rr": 1.5,             // æœ€å°é£é™©å›æŠ¥æ¯”
  "max_sl_distance_pct": 10.0,  // æœ€å¤§æ­¢æŸè·ç¦»(10%)
  "min_sl_distance_pct": 0.5,   // æœ€å°æ­¢æŸè·ç¦»(0.5%)

  // === äº¤æ˜“æ§åˆ¶ ===
  "max_concurrent_positions": 3, // æœ€å¤§åŒæ—¶æŒä»“æ•°
  "cooldown_minutes": 60         // å†·å´æ—¶é—´(åˆ†é’Ÿ)
}
```

---

## 2. ç­–ç•¥æ‰§è¡Œæµç¨‹ (StrategyOrchestrator)

### å®Œæ•´æ‰§è¡Œæ­¥éª¤

```
ç”¨æˆ·è§¦å‘ / å®šæ—¶ä»»åŠ¡
    â†“
execute_strategy(portfolio_id, market_data)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: åˆ›å»º StrategyExecution è®°å½•         â”‚
â”‚ - ID: UUID                                  â”‚
â”‚ - Status: RUNNING                           â”‚
â”‚ - Market Snapshot: åºåˆ—åŒ–å¸‚åœºæ•°æ®            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: æ‰§è¡Œä¸šåŠ¡Agentåˆ†æ                    â”‚
â”‚ âš ï¸ å½“å‰Bugæ‰€åœ¨: ç¡¬ç¼–ç æ‰§è¡Œmacro/ta/onchain   â”‚
â”‚ âœ… åº”è¯¥: æ ¹æ®business_agentsåŠ¨æ€æ‰§è¡Œ         â”‚
â”‚                                             â”‚
â”‚ åŠ¨é‡ç­–ç•¥åº”æ‰§è¡Œ:                              â”‚
â”‚   - regime_filter (Regimeè¯„ä¼°)             â”‚
â”‚   - ta_momentum (æŠ€æœ¯åŠ¨é‡åˆ†æ)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: åŠ è½½å†³ç­–Agent                       â”‚
â”‚ - åŠ¨æ€å¯¼å…¥: decision_agent_module           â”‚
â”‚ - å®ä¾‹åŒ–: decision_agent_class              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: è®¡ç®—å½“å‰ä»“ä½                         â”‚
â”‚ - éå†holdings                              â”‚
â”‚ - è®¡ç®—ä»“ä½æ¯”ä¾‹                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: å‡†å¤‡portfolio_state                 â”‚
â”‚ {                                           â”‚
â”‚   consecutive_bullish_count: 0,            â”‚
â”‚   consecutive_bearish_count: 0,            â”‚
â”‚   last_conviction_score: null              â”‚
â”‚ }                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: è°ƒç”¨å†³ç­–Agent.decide()               â”‚
â”‚ INPUT:                                      â”‚
â”‚   - agent_outputs (ä¸šåŠ¡Agentè¾“å‡º)            â”‚
â”‚   - market_data                             â”‚
â”‚   - instance_params                         â”‚
â”‚   - portfolio_state                         â”‚
â”‚   - current_position                        â”‚
â”‚                                             â”‚
â”‚ OUTPUT:                                     â”‚
â”‚   - signal (LONG/SHORT/HOLD)               â”‚
â”‚   - position_size                           â”‚
â”‚   - conviction_score                        â”‚
â”‚   - oco_order (æ­¢æŸæ­¢ç›ˆä»·æ ¼)                 â”‚
â”‚   - should_execute                          â”‚
â”‚   - reasons                                 â”‚
â”‚   - warnings                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: æ›´æ–°è¿ç»­ä¿¡å·è®¡æ•°å™¨                   â”‚
â”‚ - çœ‹æ¶¨è¿ç»­è®¡æ•°                               â”‚
â”‚ - çœ‹è·Œè¿ç»­è®¡æ•°                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 8: æ›´æ–°StrategyExecutionè®°å½•            â”‚
â”‚ - conviction_score                          â”‚
â”‚ - signal                                    â”‚
â”‚ - signal_strength                           â”‚
â”‚ - position_size                             â”‚
â”‚ - risk_level                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 9: æ‰§è¡Œäº¤æ˜“ (å¦‚æœshould_execute=true)   â”‚
â”‚ - è°ƒç”¨PaperTradingEngine                    â”‚
â”‚ - åˆ›å»ºTradeè®°å½•                             â”‚
â”‚ - æ›´æ–°Holdings                              â”‚
â”‚ - ä¿å­˜OCOè®¢å•åˆ°metadata                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 10: æ›´æ–°Portfolioä»·å€¼                   â”‚
â”‚ - æ ¹æ®å½“å‰BTCä»·æ ¼                            â”‚
â”‚ - è®¡ç®—æ€»èµ„äº§ä»·å€¼                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 11: ç”ŸæˆLLMæ€»ç»“ (GeneralAnalysisAgent) â”‚
â”‚ - ç»¼åˆAgentåˆ†æç»“æœ                          â”‚
â”‚ - ç”Ÿæˆå¸‚åœºå±•æœ›æ–‡æœ¬                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 12: æäº¤æ•°æ®åº“äº‹åŠ¡                      â”‚
â”‚ - Status: SUCCESS / FAILED                  â”‚
â”‚ - è¿”å›StrategyExecution                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ä¸šåŠ¡Agentå±‚

### 3.1 RegimeFilterAgent

**æ–‡ä»¶**: `app/agents/regime_filter_agent.py`  
**ä½œç”¨**: è¯„ä¼°å¸‚åœºå®è§‚ç¯å¢ƒå¥åº·åº¦

#### è¾“å…¥æ•°æ® (market_data)
```python
{
  # å®è§‚æ•°æ®
  "macro": {
    "dxy": 104.5,           # ç¾å…ƒæŒ‡æ•°
    "fed_rate": 5.25,       # è”é‚¦åŸºé‡‘åˆ©ç‡
    "m2_growth": 2.3,       # M2è´§å¸ä¾›åº”å¢é€Ÿ
  },
  
  # æƒ…ç»ªæ•°æ®
  "fear_greed_index": {
    "value": 65,
    "classification": "Greed"
  },
  
  # è¡ç”Ÿå“æ•°æ® (éœ€è¦Binance Futures)
  "derivatives": {
    "BTC": {
      "funding_rate": 0.0001,      # èµ„é‡‘è´¹ç‡
      "open_interest": 1500000000,  # æŒä»“é‡
      "futures_premium": 0.5        # æœŸè´§æº¢ä»·(%)
    },
    "ETH": {...},
    "SOL": {...}
  },
  
  # é“¾ä¸Šæ•°æ® (é¢„ç•™)
  "onchain": {...}
}
```

#### æ‰§è¡Œé€»è¾‘
```python
1. è§„åˆ™å¼•æ“è®¡ç®—Base Score (0-100)
   - å®è§‚å¥åº·åº¦: 30%æƒé‡
     * DXYä¸‹è·Œ â†’ åŠ åˆ†
     * åˆ©ç‡ä¸‹é™ â†’ åŠ åˆ†
     * M2å¢é•¿ â†’ åŠ åˆ†
   
   - æƒ…ç»ªæŒ‡æ ‡: 30%æƒé‡
     * Fear(0-25) â†’ -20åˆ†
     * Neutral(25-75) â†’ åŸºå‡†åˆ†
     * Greed(75-100) â†’ +10åˆ†
   
   - è¡ç”Ÿå“æŒ‡æ ‡: 40%æƒé‡
     * Funding Rate: <0.01%æ­£å¸¸, >0.05%è¿‡çƒ­
     * Open Interest: å¢é•¿â†’åŠ åˆ†, ä¸‹é™â†’å‡åˆ†
     * Futures Premium: 0-2%æ­£å¸¸, >5%è¿‡çƒ­

2. LLMå¢å¼º (å¯é€‰)
   - è¾“å…¥Base Score + åŸå§‹æ•°æ®
   - LLMè°ƒæ•´ Â±10åˆ†
   - è¾“å‡ºæœ€ç»ˆRegime Score

3. åˆ†ç±»å’Œä¹˜æ•°è®¡ç®—
   - 0-20: DANGEROUS, multiplier=0.3
   - 20-40: DANGEROUS, multiplier=0.5
   - 40-60: NEUTRAL, multiplier=0.8
   - 60-80: HEALTHY, multiplier=1.2
   - 80-100: VERY_HEALTHY, multiplier=1.6
```

#### è¾“å‡ºç»“æ„ (RegimeFilterOutput)
```python
{
  "agent_name": "regime_filter_agent",
  "timestamp": "2025-11-13T12:00:00Z",
  
  "regime_score": 65.3,                    # æ ¸å¿ƒè¾“å‡º
  "classification": "HEALTHY",
  "confidence": 0.85,
  "recommended_multiplier": 1.23,
  
  "component_scores": {                    # å„ç»´åº¦å¾—åˆ†
    "macro_health": 0.45,
    "sentiment": 0.68,
    "derivatives_btc": 0.52,
    "derivatives_eth": 0.48,
    "derivatives_sol": 0.55
  },
  
  "key_factors": [                         # å…³é”®å› ç´ 
    "ç¾å…ƒæŒ‡æ•°ä¸‹è·Œ,æœ‰åˆ©äºé£é™©èµ„äº§",
    "èµ„é‡‘è´¹ç‡æ¸©å’Œ,å¸‚åœºæœªè¿‡çƒ­",
    "æŒä»“é‡ç¨³å®šå¢é•¿,ä¹°ç›˜å¼ºåŠ²"
  ],
  
  "risk_level": "MEDIUM",
  
  "base_score": 63.0,                      # è§„åˆ™å¼•æ“å¾—åˆ†
  "llm_adjustment": +2.3                   # LLMè°ƒæ•´
}
```

---

### 3.2 TAMomentumAgent

**æ–‡ä»¶**: `app/agents/ta_momentum_agent.py`  
**ä½œç”¨**: å¤šå¸ç§æŠ€æœ¯åŠ¨é‡åˆ†æ,è¯†åˆ«æœ€ä½³äº¤æ˜“æœºä¼š

#### è¾“å…¥æ•°æ® (market_data)
```python
{
  "ohlcv": {
    "BTC": {
      "15m": [[timestamp, open, high, low, close, volume], ...],  # 200æ ¹Kçº¿
      "60m": [[...], ...]
    },
    "ETH": {...},
    "SOL": {...}
  },
  
  "current_prices": {
    "BTC": 43950.00,
    "ETH": 2280.50,
    "SOL": 98.32
  }
}
```

#### æ‰§è¡Œé€»è¾‘
```python
1. éå†æ¯ä¸ªå¸ç§ (BTC/ETH/SOL)
   FOR asset IN ["BTC", "ETH", "SOL"]:
   
   2.1 è®¡ç®—15åˆ†é’ŸæŠ€æœ¯æŒ‡æ ‡
       - EMA(12/26/50/200)
       - RSI(14)
       - MACD(12/26/9)
       - Bollinger Bands(20, 2std)
       - ATR(14)
       - Volume MA(20)
   
   2.2 è®¡ç®—60åˆ†é’ŸæŠ€æœ¯æŒ‡æ ‡ (åŒä¸Š)
   
   2.3 ç»¼åˆåˆ¤æ–­ (15mä¸»å¯¼, 60mç¡®è®¤)
       è¶‹åŠ¿åˆ¤æ–­:
         - EMAæ’åˆ—: 12>26>50>200 â†’ STRONG_UPTREND
         - MACD: é‡‘å‰ â†’ åŠ åˆ†, æ­»å‰ â†’ å‡åˆ†
       
       åŠ¨é‡åˆ¤æ–­:
         - RSI: 30-70æ­£å¸¸, >70è¶…ä¹°, <30è¶…å–
         - Price vs Bollinger: çªç ´ä¸Šè½¨â†’å¼ºåŠ¿
       
       æ³¢åŠ¨ç‡:
         - ATR: é«˜æ³¢åŠ¨â†’å¢åŠ æ­¢æŸè·ç¦»
       
       æˆäº¤é‡:
         - Volume > MA(20) â†’ ç¡®è®¤ä¿¡å·æœ‰æ•ˆ
   
   2.4 è®¡ç®—ä¿¡å·å¼ºåº¦ (0-1)
       signal_strength = (
         trend_score * 0.4 +
         momentum_score * 0.3 +
         volume_score * 0.2 +
         volatility_score * 0.1
       )
   
   2.5 ç¡®å®šæ–¹å‘å’Œä¿¡å¿ƒ
       IF signal_strength > 0.6 AND trend = UPTREND:
         â†’ signal = LONG, confidence = signal_strength
       ELIF signal_strength > 0.6 AND trend = DOWNTREND:
         â†’ signal = SHORT, confidence = signal_strength
       ELSE:
         â†’ signal = HOLD
   
   2.6 è®¡ç®—æ­¢æŸæ­¢ç›ˆå»ºè®®
       suggested_sl_distance_pct = ATR * 2 / current_price * 100
       suggested_tp_rr = 2.0 (é»˜è®¤)

2. é€‰æ‹©æœ€ä½³æœºä¼š
   best_opportunity = MAX(signal_strength * confidence)
```

#### è¾“å‡ºç»“æ„ (TAMomentumOutput)
```python
{
  "agent_name": "ta_momentum_agent",
  "timestamp": "2025-11-13T12:00:00Z",
  
  "asset_analyses": {                      # æ¯ä¸ªå¸ç§åˆ†æ
    "BTC": {
      "signal": "LONG",
      "signal_strength": 0.78,
      "confidence": 0.85,
      "trend_15m": "UPTREND",
      "trend_60m": "UPTREND",
      "rsi_15m": 62.5,
      "rsi_60m": 58.3,
      "macd_state_15m": "GOLDEN_CROSS",
      "price_vs_ema200": "ABOVE",          # ä»·æ ¼ç›¸å¯¹EMA200
      "volume_confirmation": true,
      "suggested_sl_distance_pct": 2.5,
      "suggested_tp_rr": 2.8,
      "reasoning": "15åˆ†é’Ÿå’Œ60åˆ†é’Ÿå‡ç¡®è®¤ä¸Šæ¶¨åŠ¨é‡..."
    },
    "ETH": {
      "signal": "HOLD",
      "signal_strength": 0.45,
      ...
    },
    "SOL": {
      "signal": "HOLD",
      "signal_strength": 0.52,
      ...
    }
  },
  
  "best_opportunity": {                    # æœ€ä½³æœºä¼š
    "asset": "BTC",
    "signal": "LONG",
    "signal_strength": 0.78,
    "confidence": 0.85,
    "suggested_sl_distance_pct": 2.5,
    "suggested_tp_rr": 2.8
  },
  
  "overall_momentum_strength": 0.58,       # å…¨å±€åŠ¨é‡å¼ºåº¦
  "market_trend": "UPTREND",               # æ•´ä½“å¸‚åœºè¶‹åŠ¿
  "reasoning": "BTCæŠ€æœ¯å½¢æ€æœ€ä¼˜,ETHå’ŒSOLæ¨ªç›˜æ•´ç†ä¸­"
}
```

---

## 4. å†³ç­–Agentå±‚ (MomentumRegimeDecision)

**æ–‡ä»¶**: `app/decision_agents/momentum_regime_decision.py`

### å†³ç­–è¾“å…¥
```python
agent_outputs = {
  "regime_filter": RegimeFilterOutput,
  "ta_momentum": TAMomentumOutput
}

market_data = {...}  # å¸‚åœºæ•°æ®å¿«ç…§

instance_params = {  # Portfolioçš„è‡ªå®šä¹‰å‚æ•°(è¦†ç›–default_params)
  "base_risk_pct": 2.5,  # ç”¨æˆ·è°ƒæ•´ä¸º2.5%
  ...
}

portfolio_state = {
  "consecutive_bullish_count": 0,
  "consecutive_bearish_count": 0,
  "last_conviction_score": null
}

current_position = 0.0  # å½“å‰ä»“ä½æ¯”ä¾‹
```

### å†³ç­–é€»è¾‘ (ä¸‰å±‚æ¶æ„)

#### Layer 1: Technical Analysis Layer (80%æƒé‡)
```python
# Step 1: æå–TAä¿¡å·
ta_output = agent_outputs["ta_momentum"]
best_opp = ta_output["best_opportunity"]

IF best_opp is None OR best_opp["signal"] == "HOLD":
  â†’ è¿”å› HOLDä¿¡å·

signal = best_opp["signal"]              # LONG/SHORT
ta_signal_strength = best_opp["signal_strength"]  # 0.78
ta_confidence = best_opp["confidence"]   # 0.85
asset = best_opp["asset"]                # "BTC"

# Step 2: ä¿¡å·è¿‡æ»¤
IF ta_signal_strength < min_signal_strength:  # <0.6
  â†’ è¿”å› HOLDä¿¡å·, reason="ä¿¡å·å¼ºåº¦ä¸è¶³"

IF ta_confidence < min_confidence:  # <0.5
  â†’ è¿”å› HOLDä¿¡å·, reason="ä¿¡å¿ƒæ°´å¹³ä¸è¶³"

# Step 3: è®¡ç®—TAä¸»å¯¼çš„åŸºç¡€ä»“ä½
base_position_size = (
  account_value * 
  (base_risk_pct / 100) * 
  ta_signal_strength
)

ä¾‹å¦‚:
  account_value = $10000
  base_risk_pct = 2.0
  ta_signal_strength = 0.78
  
  â†’ base_position_size = $10000 * 0.02 * 0.78 = $156
```

#### Layer 2: Regime Confirmation Layer (20%æƒé‡)
```python
# Step 4: æå–Regime Score
regime_output = agent_outputs["regime_filter"]
regime_score = regime_output["regime_score"]  # 65.3

# Step 5: æç«¯é€†åŠ¿è¿‡æ»¤ (ä¿æŠ¤èµ„é‡‘)
IF signal == "LONG" AND regime_score < 25:
  â†’ æ‹’ç»äº¤æ˜“, reason="å¸‚åœºç¯å¢ƒæåº¦å±é™©,æ‹’ç»å¼€å¤š"
  â†’ è¿”å› HOLDä¿¡å·

IF signal == "SHORT" AND regime_score > 75:
  â†’ æ‹’ç»äº¤æ˜“, reason="å¸‚åœºç¯å¢ƒæåº¦å¥åº·,æ‹’ç»å¼€ç©º"
  â†’ è¿”å› HOLDä¿¡å·

# Step 6: è®¡ç®—Regime Multiplier (0.3x-1.6x)
regime_multiplier = _calculate_regime_multiplier(regime_score)

åˆ†æ®µå‡½æ•°:
  regime_score < 25:  multiplier = 0.3
  25 <= score < 40:   multiplier = 0.3 + (score-25)/15 * 0.2 = 0.3-0.5
  40 <= score < 60:   multiplier = 0.5 + (score-40)/20 * 0.3 = 0.5-0.8
  60 <= score < 80:   multiplier = 0.8 + (score-60)/20 * 0.4 = 0.8-1.2
  score >= 80:        multiplier = 1.2 + (score-80)/20 * 0.4 = 1.2-1.6

ä¾‹å¦‚: regime_score=65.3 â†’ multiplier = 0.8 + (65.3-60)/20*0.4 = 0.906

# Step 7: è°ƒåˆ¶å‚æ•°
effective_risk_pct = base_risk_pct * regime_multiplier
effective_leverage = base_leverage * sqrt(regime_multiplier)
effective_tp_rr = default_tp_rr * regime_multiplier

ä¾‹å¦‚:
  base_risk_pct = 2.0, regime_multiplier = 0.906
  â†’ effective_risk_pct = 2.0 * 0.906 = 1.812%
  
  base_leverage = 3.0
  â†’ effective_leverage = 3.0 * sqrt(0.906) = 2.857x
  
  default_tp_rr = 2.0
  â†’ effective_tp_rr = 2.0 * 0.906 = 1.812:1

# Step 8: è®¡ç®—æœ€ç»ˆä»“ä½
final_position_size = (
  account_value * 
  (effective_risk_pct / 100) * 
  ta_signal_strength
)

ä¾‹å¦‚:
  final_position_size = $10000 * 0.01812 * 0.78 = $141.34
```

#### Layer 3: Risk Management Layer (å¼ºåˆ¶é£æ§)
```python
# Step 9: è®¡ç®—æ­¢æŸæ­¢ç›ˆä»·æ ¼
entry_price = market_data["current_prices"][asset]  # 43950.00

# æ­¢æŸè·ç¦»
sl_distance_pct = best_opp["suggested_sl_distance_pct"]  # 2.5%

IF signal == "LONG":
  stop_loss_price = entry_price * (1 - sl_distance_pct/100)
  take_profit_price = entry_price * (1 + sl_distance_pct/100 * effective_tp_rr)
ELSE:  # SHORT
  stop_loss_price = entry_price * (1 + sl_distance_pct/100)
  take_profit_price = entry_price * (1 - sl_distance_pct/100 * effective_tp_rr)

ä¾‹å¦‚ (LONG):
  entry_price = 43950
  sl_distance_pct = 2.5
  effective_tp_rr = 1.812
  
  â†’ stop_loss_price = 43950 * (1 - 0.025) = 42851.25
  â†’ take_profit_price = 43950 * (1 + 0.025*1.812) = 45941.85

# Step 10: åˆ›å»ºOCOè®¢å•
oco_order = OCOOrder(
  asset="BTC",
  side="LONG",
  entry_price=43950.00,
  entry_amount=final_position_size / entry_price,  # BTCæ•°é‡
  stop_loss_price=42851.25,
  take_profit_price=45941.85,
  stop_loss_trigger_type="mark_price",
  take_profit_trigger_type="last_price",
  leverage=effective_leverage  # 3x (æ¨¡æ‹Ÿäº¤æ˜“æš‚ä¸ç”Ÿæ•ˆ)
)

# Step 11: OCOè®¢å•éªŒè¯
is_valid, errors = oco_order.validate()

éªŒè¯è§„åˆ™:
  1. ä»·æ ¼å¿…é¡»ä¸ºæ­£
  2. æ•°é‡å¿…é¡»ä¸ºæ­£
  3. åšå¤š: SL < Entry < TP
  4. åšç©º: TP < Entry < SL
  5. æ­¢æŸè·ç¦»: 0.5% - 10%
  6. é£é™©å›æŠ¥æ¯”: >= 1.5:1

IF NOT is_valid:
  â†’ æ‹’ç»äº¤æ˜“, reason=errors
  â†’ è¿”å› HOLDä¿¡å·

# Step 12: è®¡ç®—Conviction Score
conviction_score = (
  ta_weight * ta_confidence * 100 +
  regime_weight * (regime_score)
)

ä¾‹å¦‚:
  ta_weight = 0.8, ta_confidence = 0.85
  regime_weight = 0.2, regime_score = 65.3
  
  â†’ conviction_score = 0.8*0.85*100 + 0.2*65.3 = 68 + 13.06 = 81.06
```

### å†³ç­–è¾“å‡º (DecisionOutput)
```python
{
  "signal": "LONG",                        # äº¤æ˜“ä¿¡å·
  "position_size": 0.00321,                # BTCæ•°é‡
  "conviction_score": 81.06,               # ä¿¡å¿µåˆ†æ•°
  "signal_strength": 0.78,                 # ä¿¡å·å¼ºåº¦
  "risk_level": "MEDIUM",                  # é£é™©ç­‰çº§
  "should_execute": true,                  # æ˜¯å¦æ‰§è¡Œäº¤æ˜“
  
  "oco_order": {                           # OCOè®¢å•è¯¦æƒ…
    "asset": "BTC",
    "side": "LONG",
    "entry_price": 43950.00,
    "entry_amount": 0.00321,
    "stop_loss_price": 42851.25,
    "take_profit_price": 45941.85,
    "leverage": 2.857
  },
  
  "reasons": [                             # å†³ç­–åŸå› 
    "BTCæŠ€æœ¯åŠ¨é‡å¼ºåŠ²(0.78),15må’Œ60mè¶‹åŠ¿ä¸€è‡´",
    "Regime Scoreå¥åº·(65.3),å¸‚åœºç¯å¢ƒæ”¯æŒ",
    "é£é™©å›æŠ¥æ¯”1.81:1,ç¬¦åˆè¦æ±‚"
  ],
  
  "warnings": [],                          # è­¦å‘Šä¿¡æ¯
  
  "metadata": {                            # å…ƒæ•°æ®
    "asset": "BTC",
    "ta_signal_strength": 0.78,
    "regime_score": 65.3,
    "regime_multiplier": 0.906,
    "effective_risk_pct": 1.812,
    "base_position_size": 156.00,
    "final_position_size": 141.34
  }
}
```

---

## 5. äº¤æ˜“æ‰§è¡Œå±‚ (PaperTradingEngine)

### æ‰§è¡Œæµç¨‹
```python
# Step 1: éªŒè¯è´¦æˆ·ä½™é¢
IF account_balance < oco_order.entry_amount * oco_order.entry_price:
  â†’ ä½™é¢ä¸è¶³,äº¤æ˜“å¤±è´¥

# Step 2: åˆ›å»ºTradeè®°å½•
trade = Trade(
  portfolio_id=portfolio_id,
  trade_type="BUY" if signal=="LONG" else "SELL",
  symbol=oco_order.asset,
  amount=oco_order.entry_amount,
  price=oco_order.entry_price,
  total_value=oco_order.entry_amount * oco_order.entry_price,
  fee=total_value * 0.001,  # 0.1%æ‰‹ç»­è´¹
  timestamp=datetime.utcnow()
)

# Step 3: æ›´æ–°/åˆ›å»ºHolding
holding = Holding(
  portfolio_id=portfolio_id,
  symbol=oco_order.asset,
  amount=oco_order.entry_amount,
  avg_buy_price=oco_order.entry_price,
  current_value=oco_order.entry_amount * oco_order.entry_price,
  metadata={                                # å…³é”®: OCOè®¢å•å­˜å‚¨åœ¨metadata
    "oco_order": oco_order.to_dict(),
    "created_at": datetime.utcnow().isoformat()
  }
)

# Step 4: æ›´æ–°è´¦æˆ·ä½™é¢
portfolio.cash -= (total_value + fee)

# Step 5: æ³¨å†ŒOCOè®¢å•åˆ°OCOOrderManager
oco_order_manager.register_order(
  portfolio_id=portfolio_id,
  holding_id=holding.id,
  oco_order=oco_order
)
```

---

## 6. OCOè®¢å•ç®¡ç† (OCOOrderManager)

**æ–‡ä»¶**: `app/services/trading/oco_order_manager.py`

### æ•°æ®ç»“æ„
```python
# å­˜å‚¨åœ¨Holding.metadataä¸­
{
  "oco_order": {
    "asset": "BTC",
    "side": "LONG",
    "entry_price": 43950.00,
    "stop_loss_price": 42851.25,
    "take_profit_price": 45941.85,
    "created_at": "2025-11-13T12:00:00Z"
  }
}
```

### è§¦å‘æ£€æŸ¥ (æ¯æ¬¡ç­–ç•¥æ‰§è¡Œæ—¶)
```python
# åœ¨æ¯æ¬¡ç­–ç•¥æ‰§è¡Œå‰,æ£€æŸ¥OCOè®¢å•
FOR holding IN portfolio.holdings:
  IF holding.metadata.get("oco_order"):
    oco = holding.metadata["oco_order"]
    current_price = market_data["current_prices"][oco["asset"]]
    
    # æ­¢æŸè§¦å‘
    IF oco["side"] == "LONG" AND current_price <= oco["stop_loss_price"]:
      â†’ å¹³ä»“, reason="æ­¢æŸè§¦å‘"
      â†’ åˆ é™¤holding
      â†’ è®°å½•Trade(å–å‡º)
    
    ELIF oco["side"] == "SHORT" AND current_price >= oco["stop_loss_price"]:
      â†’ å¹³ä»“, reason="æ­¢æŸè§¦å‘"
    
    # æ­¢ç›ˆè§¦å‘
    IF oco["side"] == "LONG" AND current_price >= oco["take_profit_price"]:
      â†’ å¹³ä»“, reason="æ­¢ç›ˆè§¦å‘"
      â†’ åˆ é™¤holding
      â†’ è®°å½•Trade(å–å‡º)
    
    ELIF oco["side"] == "SHORT" AND current_price <= oco["take_profit_price"]:
      â†’ å¹³ä»“, reason="æ­¢ç›ˆè§¦å‘"
```

---

## 7. æ•°æ®é‡‡é›†å±‚ (MomentumDataService)

**æ–‡ä»¶**: `app/services/data_collectors/momentum_data_service.py`

### é‡‡é›†æµç¨‹
```python
async def collect_all_data():
  # å¹¶è¡Œé‡‡é›†
  results = await asyncio.gather(
    # Kçº¿æ•°æ®
    binance_spot.get_klines("BTCUSDT", "15m", 200),
    binance_spot.get_klines("BTCUSDT", "60m", 200),
    binance_spot.get_klines("ETHUSDT", "15m", 200),
    binance_spot.get_klines("ETHUSDT", "60m", 200),
    binance_spot.get_klines("SOLUSDT", "15m", 200),
    binance_spot.get_klines("SOLUSDT", "60m", 200),
    
    # å½“å‰ä»·æ ¼
    binance_spot.get_ticker("BTCUSDT"),
    binance_spot.get_ticker("ETHUSDT"),
    binance_spot.get_ticker("SOLUSDT"),
    
    # æœŸè´§æ•°æ®
    binance_futures.get_funding_rate("BTCUSDT"),
    binance_futures.get_open_interest("BTCUSDT"),
    binance_futures.get_futures_premium("BTCUSDT"),
    # ETH/SOLåŒç†...
    
    # å®è§‚æ•°æ®
    fred.get_dxy(),
    fred.get_fed_rate(),
    fred.get_m2_growth(),
    
    # æƒ…ç»ªæ•°æ®
    alternative_me.get_fear_greed_index(),
  )
  
  # èšåˆæ•°æ®
  return {
    "ohlcv": {...},
    "current_prices": {...},
    "derivatives": {...},
    "macro": {...},
    "fear_greed_index": {...}
  }
```

---

## 8. å‰ç«¯å±•ç¤ºå±‚

### éœ€è¦çš„æ•°æ®æ¥å£

#### 8.1 Regimeå®æ—¶æ•°æ®
```
GET /api/v1/strategies/{portfolio_id}/regime-current

Response:
{
  "regime_score": 65.3,
  "classification": "HEALTHY",
  "recommended_multiplier": 1.23,
  "component_scores": {...},
  "timestamp": "2025-11-13T12:00:00Z"
}
```

#### 8.2 Holdings with OCO
```
GET /api/v1/portfolios/{portfolio_id}/holdings

Response:
{
  "holdings": [
    {
      "symbol": "BTC",
      "amount": 0.00321,
      "avg_buy_price": 43950.00,
      "current_price": 44120.00,
      "unrealized_pnl": 5.46,
      "unrealized_pnl_percent": 0.38,
      "oco_order": {                    # å…³é”®: OCOè®¢å•çŠ¶æ€
        "stop_loss_price": 42851.25,
        "take_profit_price": 45941.85,
        "entry_price": 43950.00,
        "side": "LONG",
        "created_at": "2025-11-13T12:00:00Z"
      }
    }
  ]
}
```

#### 8.3 æŠ€æœ¯æŒ‡æ ‡
```
GET /api/v1/strategies/{portfolio_id}/technical-indicators

Response:
{
  "assets": {
    "BTC": {
      "15m": {
        "ema12": 43980,
        "ema26": 43850,
        "rsi": 62.5,
        "macd_state": "GOLDEN_CROSS"
      },
      "60m": {...}
    },
    "ETH": {...},
    "SOL": {...}
  }
}
```

---

## 9. å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA COLLECTION                        â”‚
â”‚  MomentumDataService: 15m/60m OHLCV + Derivatives + ...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  BUSINESS AGENTS                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ RegimeFilterAgentâ”‚        â”‚ TAMomentumAgent  â”‚       â”‚
â”‚  â”‚ - Macro Health   â”‚        â”‚ - EMA/RSI/MACD   â”‚       â”‚
â”‚  â”‚ - Sentiment      â”‚        â”‚ - Multi-Timeframeâ”‚       â”‚
â”‚  â”‚ - Derivatives    â”‚        â”‚ - Best Opportunityâ”‚      â”‚
â”‚  â”‚ â†’ Regime Score   â”‚        â”‚ â†’ Signal+Strengthâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               DECISION AGENT                              â”‚
â”‚         MomentumRegimeDecision                            â”‚
â”‚                                                           â”‚
â”‚  Layer 1: TA Dominant (80%)                              â”‚
â”‚    - Signal Direction & Strength                         â”‚
â”‚    - Base Position Size                                  â”‚
â”‚                                                           â”‚
â”‚  Layer 2: Regime Confirmation (20%)                      â”‚
â”‚    - Extreme Counter-Trend Filter                        â”‚
â”‚    - Parameter Modulation (multiplier 0.3x-1.6x)        â”‚
â”‚                                                           â”‚
â”‚  Layer 3: Risk Management (Mandatory)                    â”‚
â”‚    - Calculate SL/TP Prices                              â”‚
â”‚    - Generate OCO Order                                  â”‚
â”‚    - Validate (SL distance, RR ratio, logic)            â”‚
â”‚                                                           â”‚
â”‚  â†’ Decision Output                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PAPER TRADING ENGINE                         â”‚
â”‚  - Validate Balance                                      â”‚
â”‚  - Create Trade Record                                   â”‚
â”‚  - Update/Create Holding (with OCO in metadata)         â”‚
â”‚  - Register OCO Order                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             OCO ORDER MANAGER                             â”‚
â”‚  - Monitor All Holdings with OCO                         â”‚
â”‚  - Check Trigger Conditions (æ¯æ¬¡æ‰§è¡Œ)                   â”‚
â”‚  - Auto Close Position on SL/TP                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FRONTEND UI                              â”‚
â”‚  - RegimeScoreGauge: æ˜¾ç¤ºRegime Scoreä»ªè¡¨ç›˜              â”‚
â”‚  - MultiAssetHoldings: BTC/ETH/SOLæŒä»“+OCOçŠ¶æ€           â”‚
â”‚  - OCOOrderStatus: æ­¢æŸ/å½“å‰/æ­¢ç›ˆä»·æ ¼è¿›åº¦æ¡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› å½“å‰é—®é¢˜æ€»ç»“

### Bug æè¿°
`StrategyOrchestrator` æ‰§è¡ŒåŠ¨é‡ç­–ç•¥æ—¶,ç¡¬ç¼–ç è°ƒç”¨äº† `macro/ta/onchain` ä¸‰ä¸ªæ—§Agent,å¯¼è‡´:
1. `RegimeFilterAgent` å’Œ `TAMomentumAgent` æ²¡æœ‰è¢«æ‰§è¡Œ
2. `MomentumRegimeDecision` æ”¶åˆ°é”™è¯¯çš„Agentè¾“å‡º
3. `DecisionOutput object is not subscriptable` é”™è¯¯(å› ä¸ºAgentè¾“å‡ºæ ¼å¼ä¸åŒ¹é…)

### è§£å†³æ–¹æ¡ˆ
éœ€è¦ä¿®æ”¹ `StrategyOrchestrator` å’Œ `RealAgentExecutor`,å®ç°åŠ¨æ€Agentæ‰§è¡Œ:
- æ ¹æ® `strategy_definition.business_agents` å­—æ®µåŠ¨æ€é€‰æ‹©Agent
- åˆ›å»ºAgentæ³¨å†Œè¡¨ (agent_name â†’ agent_instance)
- å‚è€ƒ `ResearchWorkflow._execute_business_agents()` çš„å®ç°

---

## ğŸ“ å­—æ®µæ€»ç»“è¡¨

| å±‚çº§ | å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------|--------|------|------|--------|
| **StrategyDefinition** | | | | |
| | `id` | int | ç­–ç•¥æ¨¡æ¿ID | 3 |
| | `name` | str | ç­–ç•¥å”¯ä¸€æ ‡è¯† | "momentum_regime_btc_v1" |
| | `business_agents` | list | **è¦æ‰§è¡Œçš„Agentåˆ—è¡¨** | `["regime_filter", "ta_momentum"]` |
| | `decision_agent_class` | str | å†³ç­–Agentç±»å | "MomentumRegimeDecision" |
| | `default_params` | dict | é»˜è®¤å‚æ•°é…ç½® | `{base_risk_pct: 2.0, ...}` |
| **RegimeFilterOutput** | | | | |
| | `regime_score` | float | å¸‚åœºç¯å¢ƒè¯„åˆ† | 65.3 |
| | `classification` | str | ç¯å¢ƒåˆ†ç±» | "HEALTHY" |
| | `recommended_multiplier` | float | æ¨èä»“ä½ä¹˜æ•° | 1.23 |
| | `component_scores` | dict | å„ç»´åº¦å¾—åˆ† | `{macro_health: 0.45, ...}` |
| **TAMomentumOutput** | | | | |
| | `asset_analyses` | dict | å„å¸ç§åˆ†æ | `{BTC: {...}, ETH: {...}}` |
| | `best_opportunity` | dict | æœ€ä½³äº¤æ˜“æœºä¼š | `{asset: "BTC", signal: "LONG", ...}` |
| | `signal_strength` | float | ä¿¡å·å¼ºåº¦ | 0.78 |
| | `suggested_sl_distance_pct` | float | å»ºè®®æ­¢æŸè·ç¦» | 2.5 |
| **DecisionOutput** | | | | |
| | `signal` | str | äº¤æ˜“ä¿¡å· | "LONG" |
| | `position_size` | float | äº¤æ˜“æ•°é‡ | 0.00321 |
| | `conviction_score` | float | ä¿¡å¿µåˆ†æ•° | 81.06 |
| | `oco_order` | dict | OCOè®¢å•è¯¦æƒ… | `{asset: "BTC", stop_loss_price: ..., ...}` |
| | `should_execute` | bool | æ˜¯å¦æ‰§è¡Œäº¤æ˜“ | true |
| **OCOOrder** | | | | |
| | `asset` | str | äº¤æ˜“å¸ç§ | "BTC" |
| | `side` | str | æ–¹å‘ | "LONG" |
| | `entry_price` | float | å…¥åœºä»· | 43950.00 |
| | `stop_loss_price` | float | æ­¢æŸä»· | 42851.25 |
| | `take_profit_price` | float | æ­¢ç›ˆä»· | 45941.85 |
| | `leverage` | float | æ æ†å€æ•° | 2.857 |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**åˆ›å»ºæ—¶é—´**: 2025-11-13  
**çŠ¶æ€**: å®Œæ•´é€»è¾‘æè¿° + Bugè¯Šæ–­  
**ä¸‹ä¸€æ­¥**: ä¿®å¤Agentæ‰§è¡Œé€»è¾‘

