# 动量策略核心修正说明

> **修正日期**: 2025-11-13  
> **修正原因**: 用户反馈要求技术分析主导,Regime仅辅助确认和增强

---

## ✅ 核心修正点

### 1. **决策权重调整**

| 维度 | 修正前 | 修正后 |
|-----|-------|--------|
| **决策主导** | Regime Score决定是否交易 | **技术分析决定是否交易** ⭐ |
| **技术分析角色** | 生成信号,被动等待Regime批准 | **主动生成信号,主导决策** ⭐ |
| **Regime角色** | 完全控制交易开关 | **仅做确认和增强** ⭐ |
| **权重比例** | Regime 50% : TA 50% | **TA 80% : Regime 20%** ⭐ |

---

### 2. **决策流程重构**

#### 修正前的流程 (❌ 错误逻辑):

```
Step 1: 检查Regime Score
  if Regime < 30 → ❌ 暂停所有交易 (问题: Regime完全阻止交易)
  
Step 2: 生成TA信号 (被动角色)
  
Step 3: 根据Regime调制参数
```

**问题**: Regime Score < 30时,即使技术信号极强,也完全不交易。这让Regime成了主导。

---

#### 修正后的流程 (✅ 正确逻辑):

```
Step 1: TAMomentumAgent生成技术信号 (⭐ 主导决策)
  对每个币种:
    → LONG/SHORT/NEUTRAL + signal_strength (0-1)
  
  if signal = NEUTRAL → 直接跳过 (技术主导)

Step 2: RegimeFilterAgent评估市场环境 (辅助确认)
  → Regime Score (0-100)
  ⭐ Regime不决定"是否交易",只决定"交易强度"

Step 3: 极端逆势过滤 (Regime辅助作用)
  if signal=LONG and Regime<15 → 可选跳过或极小仓位(0.3x)
  if signal=SHORT and Regime>85 → 可选跳过或极小仓位(0.3x)
  
  ⭐ 其他情况都可以交易

Step 4: 计算最终参数 (TA为基础,Regime调制)
  
  4.1 技术分析基础仓位:
    TA_Base_Position = Base_Risk_Pct × TA_Signal_Strength
    
    例如:
    - TA强度0.85 → 基础仓位 0.5% × 0.85 = 0.425%
  
  4.2 Regime调制系数 (仅放大/缩小):
    Regime < 20:  0.3x  (减仓但不禁止)
    20-40:        0.6x
    40-60:        1.0x  (不调整)
    60-80:        1.3x  (增强)
    >= 80:        1.6x  (大幅增强)
  
  4.3 最终仓位:
    Final = TA_Base × Regime_Multiplier
    
    例如:
    - TA 0.425% × Regime 1.3x = 0.5525%
```

**优势**: 技术信号主导,Regime只做适度调节,不会完全阻止交易。

---

### 3. **强制止盈止损** ✅

#### 硬性要求:

```python
⭐ 每笔开仓必须同时设置:
1. Stop Loss (止损) - 基于ATR计算
2. Take Profit (止盈) - 基于风险回报比

使用OCO订单 (One-Cancels-Other):
- 止损触发 → 自动平仓
- 止盈触发 → 自动平仓
- 一个触发,另一个自动取消

⚠️ 没有SL/TP的订单 → 系统拒绝执行
```

#### 实现细节:

```python
# 开仓时生成OCO订单
{
  "order_type": "MARKET",  // 市价入场
  "entry_price": 95300.0,
  "position_size": 0.0787,
  "leverage": 3.42,
  
  "oco_orders": [  // ✅ 必须同时设置
    {
      "type": "STOP_LOSS",
      "price": 92900.0,  // Entry - (ATR × 2.0)
      "trigger": "mark_price"  // 使用标记价格,防止插针
    },
    {
      "type": "TAKE_PROFIT",
      "price": 100388.0,  // Entry + (ATR × 2.0 × TP_RR)
      "trigger": "last_price"
    }
  ]
}

# 风控验证
def validate_trade(order):
    ✅ assert order.has_stop_loss, "必须设置止损"
    ✅ assert order.has_take_profit, "必须设置止盈"
    ✅ assert 0.5% <= order.sl_distance <= 10%, "止损距离合理"
    ✅ assert order.tp_rr_ratio >= 1.5, "风险回报比>=1.5"
```

---

## 📊 修正后的架构图

```
┌─────────────────────────────────────────┐
│  Technical Analysis Layer (技术分析层)   │
│  多时间框架技术指标 → 生成交易信号        │
│  决定"做什么交易"(LONG/SHORT/NEUTRAL)    │
│  ⭐⭐⭐ 主导决策 - 权重80% ⭐⭐⭐        │
└─────────────────┬───────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│  Regime Confirmation Layer (制度确认层)  │
│  AI评估市场健康度 → Regime Score 0-100   │
│  1. 过滤极端逆势 (Long<15, Short>85)     │
│  2. 调制仓位/杠杆 (0.3x ~ 1.6x)          │
│  ⭐ 辅助增强 - 权重20% ⭐                │
└─────────────────┬───────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│  Risk Management Layer (风控层)          │
│  ✅ 强制止盈止损 (基于ATR)               │
│  ✅ OCO订单同时设置                      │
│  ✅ 不允许裸仓交易                       │
└─────────────────────────────────────────┘
```

---

## 🔢 决策计算示例

### 场景: BTC技术信号强,Regime健康

```
输入:
- TA_Signal: LONG
- TA_Signal_Strength: 0.85 (技术信号很强)
- Regime_Score: 75 (市场健康)
- Base_Risk_Pct: 0.5%
- Total_Equity: $10,000

计算过程:

Step 1: 技术分析基础仓位 (⭐ 主导)
  TA_Base = 0.5% × 0.85 = 0.425%
  Risk_Base = $10,000 × 0.425% = $42.5

Step 2: Regime调制系数 (辅助)
  Regime_Score = 75 → Regime_Multiplier = 1.3x

Step 3: 最终有效参数
  Effective_Risk_Pct = 0.425% × 1.3 = 0.5525%
  Effective_Risk_USD = $10,000 × 0.5525% = $55.25
  
  Effective_Leverage = 3.0 × sqrt(1.3) ≈ 3.42x
  Effective_TP_RR = 2.0 × (1 + 0.2×0.3) = 2.12

Step 4: 仓位和止损止盈计算
  ATR = 1200, SL_Distance = 1200 × 2.0 = 2400
  
  Position_Size = ($55.25 × 3.42) / 2400 = 0.0787 BTC
  
  ✅ Stop_Loss = 95300 - 2400 = 92900
  ✅ Take_Profit = 95300 + (2400 × 2.12) = 100388

结果:
  - 技术信号强(0.85) → 基础仓位0.425%
  - Regime健康(75) → 增强到0.5525%
  - 必须设置SL=92900, TP=100388
```

---

## 📝 关键代码改动

### MomentumRegimeDecision.decide()

```python
# ❌ 修正前
if regime_score < 30:
    return {"action": "HOLD"}  # 完全阻止交易

# ✅ 修正后
# 先看技术信号
if ta_output.signal == "NEUTRAL":
    return {"action": "HOLD"}  # 技术主导

# 技术有信号,Regime只做调制
regime_multiplier = calculate_regime_multiplier(regime_score)
# regime_score < 20 → 0.3x (减仓但不禁止)
# regime_score >= 80 → 1.6x (增强)

final_risk = ta_base_risk × regime_multiplier
```

---

## ✅ 确认清单

请确认以下修正是否符合你的要求:

- [ ] **技术分析主导** - TA信号决定是否交易 ✅
- [ ] **Regime辅助** - 只做确认和增幅,不完全阻止交易 ✅
- [ ] **强制止盈止损** - 每笔必须设置SL/TP,使用OCO订单 ✅
- [ ] **Regime调制** - 仅在TA基础上放大/缩小(0.3x~1.6x) ✅
- [ ] **极端过滤** - 只过滤极端逆势(Long<15, Short>85) ✅
- [ ] **权重比例** - TA 80% : Regime 20% ✅

---

## 📄 完整方案文档

修正后的完整方案已保存至:
```
/Users/uniteyoo/Documents/AutoMoney/docs/动量策略/动量策略产品开发方案.md
```

包含了:
- ✅ 修正后的决策流程
- ✅ 强制止盈止损的详细实现
- ✅ 技术主导的代码结构
- ✅ 完整的输出示例
- ✅ 所有相关的计算公式

---

**如果确认无误,我可以立即开始Phase 1开发!** 🚀

