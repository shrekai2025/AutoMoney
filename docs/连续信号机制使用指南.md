# 连续信号机制使用指南

## 📖 什么是连续信号机制?

连续信号机制是一种**自适应仓位放大**策略,当策略连续多次产生看涨信号时,会逐渐增加每次买入的资金比例,以更好地捕捉确定性较高的趋势。

### 核心原理

1. **信号检测**: 每次策略执行时计算信念分数(Conviction Score 0-100)
2. **连续计数**: 当分数≥70(看涨信号)时,连续次数+1;否则重置为0
3. **触发加速**: 连续次数达到设定阈值(默认30次)后,激活加速机制
4. **仓位放大**: 应用乘数(默认1.1-2.0)放大每次买入的资金比例

---

## 🎯 工作示例

### 基础配置 (默认)
- **连续信号阈值**: 30次
- **最小乘数**: 1.1x
- **最大乘数**: 2.0x

### 场景模拟

#### 场景1: 未达到阈值
```
执行1-29次:
  Conviction Score: 75
  信号: BUY
  连续次数: 1→29
  仓位大小: 0.003 (基础仓位,无加速)
```

#### 场景2: 达到阈值并加速
```
执行30次:
  Conviction Score: 75
  信号: BUY
  连续次数: 30 ✅ 触发加速!
  仓位大小: 0.0033 (0.003 × 1.1 = 0.0033)

执行50次:
  连续次数: 50
  乘数: 1.28x
  仓位大小: 0.00384 (0.003 × 1.28)

执行130次:
  连续次数: 130
  乘数: 2.0x (达到最大值)
  仓位大小: 0.006 (0.003 × 2.0)
```

#### 场景3: 信号中断,计数重置
```
执行131次:
  Conviction Score: 55 (下降到HOLD区间)
  信号: HOLD
  连续次数: 130→0 (重置)
  仓位大小: 0 (不执行交易)
```

---

## 🔧 如何配置?

### 步骤1: 登录Admin面板
访问Admin面板(需要管理员权限)

### 步骤2: 打开策略设置
1. 找到要配置的策略
2. 点击"Settings"按钮
3. 切换到"Consecutive Signals"标签页

### 步骤3: 调整参数

#### 连续信号阈值
- **说明**: 需要连续多少次看涨信号才触发加速
- **范围**: 1-1000次
- **建议值**:
  - 保守: 40-50次
  - 平衡: 30次 (默认)
  - 激进: 20-25次

#### 加速乘数 - 最小值
- **说明**: 刚达到阈值时的仓位乘数
- **范围**: 1.0-5.0
- **建议值**:
  - 保守: 1.05-1.1
  - 平衡: 1.1 (默认)
  - 激进: 1.2-1.3

#### 加速乘数 - 最大值
- **说明**: 连续信号持续时的最大乘数
- **范围**: 1.0-5.0
- **建议值**:
  - 保守: 1.5-1.8
  - 平衡: 2.0 (默认)
  - 激进: 2.5-3.0

### 步骤4: 保存设置
点击"Save Changes"按钮

---

## 📊 配置示例

### 示例1: 保守型
适合风险厌恶型投资者,希望缓慢放大仓位
```
阈值: 40次
最小乘数: 1.1
最大乘数: 1.5

效果:
- 连续40次: 1.1x
- 连续70次: 1.33x
- 连续140次+: 1.5x
```

### 示例2: 平衡型 (默认)
适合大多数用户,兼顾收益和风险
```
阈值: 30次
最小乘数: 1.1
最大乘数: 2.0

效果:
- 连续30次: 1.1x
- 连续65次: 1.415x
- 连续130次+: 2.0x
```

### 示例3: 激进型
适合风险承受能力强的投资者,快速放大仓位
```
阈值: 20次
最小乘数: 1.2
最大乘数: 3.0

效果:
- 连续20次: 1.2x
- 连续60次: 1.92x
- 连续120次+: 3.0x
```

---

## 🔍 如何监控?

### 查看连续信号状态

#### 方法1: Portfolio详情
在前端查看Portfolio卡片,新增字段:
- **连续看涨次数**: 当前累积的连续次数
- **连续开始时间**: 何时开始累积
- **上次信念分数**: 最近一次的分数

#### 方法2: 策略执行记录
在StrategyExecution中查看:
- **signal**: BUY表示看涨,HOLD/SELL会重置计数
- **conviction_score**: 分数≥70才会累积
- **position_size**: 实际仓位大小(已应用乘数)

#### 方法3: 日志
查看后端日志,关键信息:
```
连续看涨信号 +1: 30 (阈值: 30)
触发加速积累 (连续30次 >= 30, 仓位乘数: 1.10x)
连续信号中断, 重置计数器 (之前: 30, 当前信念分数: 55.0)
```

---

## ⚠️ 注意事项

### 1. 计数器重置条件
连续信号会在以下情况重置为0:
- ✅ Conviction Score < 70 (HOLD或SELL信号)
- ✅ 策略暂停后重新启动
- ❌ **不会**因时间间隔而重置(即使间隔数天)

### 2. 仓位叠加效应
```
假设:
- 总资金: $10,000
- 基础仓位: 0.5%
- 连续50次,乘数1.28x

每次买入:
- 无加速: $50 (10000 × 0.005)
- 有加速: $64 (10000 × 0.005 × 1.28)

50次累计:
- 无加速: $2,500
- 有加速: 约$3,200 (多投入$700)
```

### 3. 风险控制
连续信号机制**不会**绕过以下风控:
- ✅ 熔断机制(极度恐惧/高波动/美元强势)
- ✅ 仓位上限(最大0.5% × 乘数)
- ✅ 止盈/止损规则
- ✅ 波动率调整

### 4. 信念分数计算
连续信号基于Conviction Score,该分数由3个Agent综合计算:
- MacroAgent: 40% (宏观经济)
- OnChainAgent: 40% (链上数据)
- TAAgent: 20% (技术分析)

如果你调整了Agent权重,连续信号的触发频率也会改变。

---

## 💡 最佳实践

### 1. 回测验证
在实盘应用前,建议:
1. 使用历史数据回测不同配置
2. 观察连续次数的分布(中位数、最大值)
3. 对比有/无加速的收益和风险

### 2. 渐进式调整
不建议一次性大幅调整参数,推荐:
1. 先从默认配置开始
2. 每周观察连续信号触发情况
3. 小步调整(如阈值±5次, 乘数±0.1)
4. 记录调整前后的绩效变化

### 3. 市场环境适配
不同市场环境可采用不同配置:

**牛市初期**:
- 阈值: 25-30 (更容易触发)
- 乘数: 1.1-2.0 (标准放大)

**牛市中期**:
- 阈值: 30-35 (稍微保守)
- 乘数: 1.1-1.8 (适度放大)

**牛市末期**:
- 阈值: 35-40 (更加保守)
- 乘数: 1.05-1.5 (小幅放大)

**熊市/震荡**:
- 阈值: 40-50 (很难触发)
- 乘数: 1.1-1.3 (轻微放大)

### 4. 定期审视
建议每月检查:
- 过去30天连续信号触发次数
- 加速期间的平均收益率
- 是否有频繁重置的情况(市场震荡)

---

## 🆘 常见问题

### Q1: 为什么连续次数一直是0?
**A**: 可能原因:
1. Conviction Score一直低于70
2. Agent权重配置导致分数偏低
3. 市场环境不支持看涨信号

**解决方法**: 检查最近的StrategyExecution记录,查看conviction_score分布

### Q2: 乘数没有达到最大值?
**A**: 乘数在100次内线性增长到最大值,公式:
```
multiplier = min + (count - threshold) × (max - min) / 100
```
达到`threshold + 100`次才会到达最大值。

### Q3: 配置修改后没生效?
**A**: 配置立即生效,但需要下次策略执行时才会应用。检查:
1. 配置是否正确保存(刷新页面查看)
2. 策略是否处于活跃状态
3. 查看下次执行的日志

### Q4: 如何禁用连续信号机制?
**A**: 将最小和最大乘数都设为1.0,这样即使触发也不会放大仓位。

---

## 📈 性能指标

根据测试数据:
- **计算开销**: <1ms (可忽略)
- **数据库查询**: 复用Portfolio查询,无额外开销
- **内存占用**: 6个字段约50字节

连续信号机制对系统性能几乎无影响,可放心使用。

---

## 📞 技术支持

如遇到问题,请提供以下信息:
1. Portfolio ID
2. 连续信号配置(阈值、乘数)
3. 最近10次StrategyExecution的ID
4. 预期行为 vs 实际行为

查看详细技术文档: `/AMbackend/DEBUG_REPORT.md`
