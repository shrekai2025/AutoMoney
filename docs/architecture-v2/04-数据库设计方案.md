# æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆ

> ç‰ˆæœ¬: 2.0  
> æ›´æ–°æ—¥æœŸ: 2025-11-05  
> ç›®æ ‡: å®šä¹‰å®Œæ•´çš„æ•°æ®åº“è¡¨ç»“æ„ã€ç´¢å¼•ã€æ—¶åºæ•°æ®ä¼˜åŒ–

---

## ä¸€ã€æ•°æ®åº“æ¶æ„æ€»è§ˆ

### 1.1 æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | ç”¨é€” |
|-----|------|------|
| **ä¸»æ•°æ®åº“** | PostgreSQL 16 | å…³ç³»å‹æ•°æ® |
| **æ—¶åºæ‰©å±•** | TimescaleDB 2.13+ | Kçº¿ã€Agentè®°å½• |
| **ORM** | SQLAlchemy 2.0+ | å¯¹è±¡å…³ç³»æ˜ å°„ |
| **è¿ç§»å·¥å…·** | Alembic | ç‰ˆæœ¬æ§åˆ¶ |
| **ç¼“å­˜** | Redis 7.x | çƒ­æ•°æ®ç¼“å­˜ |

### 1.2 æ•°æ®åˆ†ç±»

```
æ•°æ®ç±»å‹åˆ†ç±»ï¼š
â”œâ”€ ä¸šåŠ¡æ•°æ®ï¼ˆPostgreSQLï¼‰
â”‚  â”œâ”€ ç”¨æˆ·æ•°æ®ï¼ˆusers, sessionsï¼‰
â”‚  â”œâ”€ ç­–ç•¥æ•°æ®ï¼ˆstrategies, subscriptionsï¼‰
â”‚  â”œâ”€ äº¤æ˜“æ•°æ®ï¼ˆtrades, portfolioï¼‰
â”‚  â””â”€ é…ç½®æ•°æ®ï¼ˆstrategy_configsï¼‰
â”‚
â”œâ”€ æ—¶åºæ•°æ®ï¼ˆTimescaleDB Hypertableï¼‰
â”‚  â”œâ”€ Kçº¿æ•°æ®ï¼ˆmarket_dataï¼‰
â”‚  â”œâ”€ Agentåˆ†æï¼ˆagent_resultsï¼‰
â”‚  â””â”€ ç­–ç•¥æ‰§è¡Œï¼ˆstrategy_executionsï¼‰
â”‚
â””â”€ ç¼“å­˜æ•°æ®ï¼ˆRedisï¼‰
   â”œâ”€ Sessionå­˜å‚¨
   â”œâ”€ Agent Scoreç¼“å­˜
   â””â”€ APIé™æµè®¡æ•°
```

---

## äºŒã€æ ¸å¿ƒè¡¨è®¾è®¡

### 2.1 ç”¨æˆ·ç›¸å…³è¡¨

#### usersï¼ˆç”¨æˆ·è¡¨ï¼‰

**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯

```python
from sqlalchemy import Column, String, DateTime, Numeric, Boolean, Index
from sqlalchemy.dialects.postgresql import UUID
import uuid

class User(Base):
    __tablename__ = 'users'
    
    # ä¸»é”®
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    
    # Google OAuthä¿¡æ¯
    google_id = Column(String(255), unique=True, nullable=False, index=True)
    email = Column(String(255), unique=True, nullable=False, index=True)
    name = Column(String(255), nullable=False)
    avatar_url = Column(String(500))
    
    # è´¦æˆ·ä¿¡æ¯
    initial_capital = Column(Numeric(20, 2), default=10000.00)  # åˆå§‹èµ„é‡‘
    subscription_tier = Column(String(20), default='free')  # free/basic/pro/enterprise
    
    # çŠ¶æ€
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, nullable=False)
    updated_at = Column(DateTime, nullable=False)
    last_login_at = Column(DateTime)
    
    # ç´¢å¼•
    __table_args__ = (
        Index('idx_users_email', 'email'),
        Index('idx_users_google_id', 'google_id'),
    )
```

**å­—æ®µè¯´æ˜**:
- `id`: UUIDä¸»é”®ï¼Œå…¨å±€å”¯ä¸€
- `google_id`: Google OAuthç”¨æˆ·IDï¼Œç”¨äºå…³è”
- `subscription_tier`: è®¢é˜…å±‚çº§ï¼ˆå½±å“åŠŸèƒ½æƒé™ï¼‰
- `initial_capital`: æ¨¡æ‹Ÿäº¤æ˜“åˆå§‹èµ„é‡‘

#### sessionsï¼ˆä¼šè¯è¡¨ï¼‰

**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·ç™»å½•ä¼šè¯ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ç”¨Redisï¼‰

```python
class Session(Base):
    __tablename__ = 'sessions'
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey('users.id'), nullable=False)
    token_hash = Column(String(255), unique=True, nullable=False)  # JWT hash
    expires_at = Column(DateTime, nullable=False)
    created_at = Column(DateTime, nullable=False)
    last_active_at = Column(DateTime)
    
    # å…³ç³»
    user = relationship("User", backref="sessions")
    
    __table_args__ = (
        Index('idx_sessions_user_id', 'user_id'),
        Index('idx_sessions_token_hash', 'token_hash'),
    )
```

---

### 2.2 ç­–ç•¥ç›¸å…³è¡¨

#### strategiesï¼ˆç­–ç•¥è¡¨ï¼‰

**ç”¨é€”**: å­˜å‚¨ç­–ç•¥æ¨¡æ¿é…ç½®ï¼ˆç¡¬ç¼–ç ç­–ç•¥ï¼‰

```python
class Strategy(Base):
    __tablename__ = 'strategies'
    
    id = Column(String(50), primary_key=True)  # å¦‚ï¼šhodl-wave
    name = Column(String(255), nullable=False)
    description = Column(Text)
    
    # ç­–ç•¥å‚æ•°
    timeframe = Column(String(20), nullable=False)  # 4h, 1d
    risk_level = Column(String(20), default='medium')  # low/medium/high
    min_capital = Column(Numeric(20, 2), default=1000.00)
    
    # Agentæƒé‡é…ç½®ï¼ˆJSONï¼‰
    agent_weights = Column(JSON, nullable=False)
    # ç¤ºä¾‹: {"macro": 0.4, "onchain": 0.4, "ta": 0.2}
    
    # æ‰§è¡Œé…ç½®ï¼ˆJSONï¼‰
    execution_config = Column(JSON)
    # ç¤ºä¾‹: {"cron": "0 */4 * * *", "max_position": 0.05}
    
    # æ€§èƒ½æŒ‡æ ‡ï¼ˆå†å²å›æµ‹ï¼‰
    sharpe_ratio = Column(Numeric(10, 2))
    max_drawdown = Column(Numeric(10, 2))
    win_rate = Column(Numeric(10, 2))
    total_return_pct = Column(Numeric(10, 2))
    
    # çŠ¶æ€
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, nullable=False)
    updated_at = Column(DateTime, nullable=False)
```

**å­—æ®µè¯´æ˜**:
- `agent_weights`: JSONå­˜å‚¨å„Agentæƒé‡ï¼Œçµæ´»é…ç½®
- `execution_config`: å­˜å‚¨cronè¡¨è¾¾å¼ã€ä»“ä½é™åˆ¶ç­‰
- æ€§èƒ½æŒ‡æ ‡å­—æ®µç”¨äºç­–ç•¥å¸‚åœºå±•ç¤º

#### strategy_subscriptionsï¼ˆç­–ç•¥è®¢é˜…è¡¨ï¼‰

**ç”¨é€”**: ç”¨æˆ·è®¢é˜…ç­–ç•¥çš„å…³ç³»è¡¨

```python
class StrategySubscription(Base):
    __tablename__ = 'strategy_subscriptions'
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey('users.id'), nullable=False)
    strategy_id = Column(String(50), ForeignKey('strategies.id'), nullable=False)
    
    # è®¢é˜…é…ç½®
    allocated_capital = Column(Numeric(20, 2), nullable=False)  # åˆ†é…èµ„é‡‘
    status = Column(String(20), default='active')  # active/paused/stopped
    
    # è‡ªå®šä¹‰é…ç½®ï¼ˆå¯é€‰ï¼Œè¦†ç›–ç­–ç•¥é»˜è®¤å€¼ï¼‰
    custom_weights = Column(JSON)  # ç”¨æˆ·è‡ªå®šä¹‰Agentæƒé‡
    
    # æ—¶é—´
    subscribed_at = Column(DateTime, nullable=False)
    paused_at = Column(DateTime)
    stopped_at = Column(DateTime)
    
    # å…³ç³»
    user = relationship("User", backref="subscriptions")
    strategy = relationship("Strategy", backref="subscriptions")
    
    __table_args__ = (
        Index('idx_subs_user_strategy', 'user_id', 'strategy_id'),
        # å”¯ä¸€çº¦æŸï¼šåŒä¸€ç”¨æˆ·ä¸èƒ½é‡å¤è®¢é˜…åŒä¸€ç­–ç•¥
        UniqueConstraint('user_id', 'strategy_id', name='uq_user_strategy'),
    )
```

---

### 2.3 æŠ•èµ„ç»„åˆç›¸å…³è¡¨

#### portfoliosï¼ˆæŠ•èµ„ç»„åˆè¡¨ï¼‰

**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·æŠ•èµ„ç»„åˆæ€»è§ˆ

```python
class Portfolio(Base):
    __tablename__ = 'portfolios'
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey('users.id'), unique=True, nullable=False)
    
    # èµ„é‡‘æ•°æ®
    initial_capital = Column(Numeric(20, 2), nullable=False)
    cash_balance = Column(Numeric(20, 2), nullable=False)  # å¯ç”¨ç°é‡‘
    total_value = Column(Numeric(20, 2), nullable=False)  # æ€»èµ„äº§
    
    # ç›ˆäºæ•°æ®
    realized_pnl = Column(Numeric(20, 2), default=0)  # å·²å®ç°ç›ˆäº
    unrealized_pnl = Column(Numeric(20, 2), default=0)  # æœªå®ç°ç›ˆäº
    total_return_pct = Column(Numeric(10, 2), default=0)  # æ€»æ”¶ç›Šç‡
    
    # æ—¶é—´
    created_at = Column(DateTime, nullable=False)
    updated_at = Column(DateTime, nullable=False)
    last_trade_at = Column(DateTime)
    
    # å…³ç³»
    user = relationship("User", backref=backref("portfolio", uselist=False))
    
    __table_args__ = (
        Index('idx_portfolios_user_id', 'user_id'),
    )
```

#### portfolio_holdingsï¼ˆæŒä»“è¡¨ï¼‰

**ç”¨é€”**: å­˜å‚¨å…·ä½“èµ„äº§æŒä»“

```python
class PortfolioHolding(Base):
    __tablename__ = 'portfolio_holdings'
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    portfolio_id = Column(UUID(as_uuid=True), ForeignKey('portfolios.id'), nullable=False)
    
    # èµ„äº§ä¿¡æ¯
    asset = Column(String(20), nullable=False)  # BTC, ETH
    quantity = Column(Numeric(20, 8), nullable=False)  # æŒæœ‰æ•°é‡ï¼ˆ8ä½å°æ•°ç²¾åº¦ï¼‰
    
    # æˆæœ¬ä¿¡æ¯
    avg_cost = Column(Numeric(20, 2), nullable=False)  # å¹³å‡æˆæœ¬
    total_cost = Column(Numeric(20, 2), nullable=False)  # æ€»æˆæœ¬
    
    # å½“å‰ä»·å€¼
    current_price = Column(Numeric(20, 2))  # æœ€æ–°ä»·æ ¼
    current_value = Column(Numeric(20, 2))  # å½“å‰ä»·å€¼
    
    # ç›ˆäº
    unrealized_pnl = Column(Numeric(20, 2), default=0)
    unrealized_pnl_pct = Column(Numeric(10, 2), default=0)
    
    # æ—¶é—´
    created_at = Column(DateTime, nullable=False)
    updated_at = Column(DateTime, nullable=False)
    
    # å…³ç³»
    portfolio = relationship("Portfolio", backref="holdings")
    
    __table_args__ = (
        Index('idx_holdings_portfolio_asset', 'portfolio_id', 'asset'),
        # åŒä¸€ç»„åˆä¸èƒ½æœ‰é‡å¤èµ„äº§
        UniqueConstraint('portfolio_id', 'asset', name='uq_portfolio_asset'),
    )
```

---

### 2.4 äº¤æ˜“ç›¸å…³è¡¨

#### tradesï¼ˆäº¤æ˜“è®°å½•è¡¨ï¼‰

**ç”¨é€”**: è®°å½•æ¯ä¸€ç¬”äº¤æ˜“

```python
class Trade(Base):
    __tablename__ = 'trades'
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), ForeignKey('users.id'), nullable=False)
    portfolio_id = Column(UUID(as_uuid=True), ForeignKey('portfolios.id'), nullable=False)
    strategy_id = Column(String(50), ForeignKey('strategies.id'))
    
    # äº¤æ˜“ä¿¡æ¯
    asset = Column(String(20), nullable=False)
    action = Column(String(10), nullable=False)  # BUY/SELL
    quantity = Column(Numeric(20, 8), nullable=False)
    price = Column(Numeric(20, 2), nullable=False)
    total_value = Column(Numeric(20, 2), nullable=False)
    
    # æ‰‹ç»­è´¹
    fee = Column(Numeric(20, 2), default=0)
    fee_rate = Column(Numeric(10, 4), default=0.001)  # 0.1%
    
    # å†³ç­–ä¿¡æ¯
    conviction_score = Column(Numeric(5, 2))  # 0-100
    signal_reasoning = Column(Text)  # Agentæ¨ç†è¿‡ç¨‹
    
    # ç›ˆäºï¼ˆä»…SELLæ—¶æœ‰å€¼ï¼‰
    realized_pnl = Column(Numeric(20, 2))
    realized_pnl_pct = Column(Numeric(10, 2))
    
    # çŠ¶æ€
    status = Column(String(20), default='pending')  # pending/executed/failed
    executed_at = Column(DateTime)
    created_at = Column(DateTime, nullable=False)
    
    # å…³ç³»
    user = relationship("User", backref="trades")
    portfolio = relationship("Portfolio", backref="trades")
    strategy = relationship("Strategy", backref="trades")
    
    __table_args__ = (
        Index('idx_trades_user_id', 'user_id'),
        Index('idx_trades_strategy_id', 'strategy_id'),
        Index('idx_trades_created_at', 'created_at'),
        Index('idx_trades_user_time', 'user_id', 'created_at'),
    )
```

**å­—æ®µè¯´æ˜**:
- `conviction_score`: è®°å½•åšå‡ºæ­¤å†³ç­–æ—¶çš„ä¿¡å¿µåˆ†æ•°
- `signal_reasoning`: ä¿å­˜LLMæ¨ç†è¿‡ç¨‹ï¼ˆå¯è¿½æº¯ï¼‰
- `realized_pnl`: SELLæ—¶è®¡ç®—å®é™…ç›ˆäº

---

## ä¸‰ã€æ—¶åºæ•°æ®è¡¨ï¼ˆTimescaleDB Hypertableï¼‰

### 3.1 market_dataï¼ˆå¸‚åœºæ•°æ®è¡¨ï¼‰

**ç”¨é€”**: å­˜å‚¨Kçº¿ã€ä»·æ ¼ç­‰æ—¶åºæ•°æ®

```python
class MarketData(Base):
    __tablename__ = 'market_data'
    
    # ä¸»é”®ï¼šæ—¶é—´ + èµ„äº§ + å‘¨æœŸ
    timestamp = Column(DateTime, primary_key=True)
    asset = Column(String(20), primary_key=True)
    timeframe = Column(String(10), primary_key=True)  # 1m, 5m, 1h, 4h, 1d
    
    # OHLCVæ•°æ®
    open = Column(Numeric(20, 2), nullable=False)
    high = Column(Numeric(20, 2), nullable=False)
    low = Column(Numeric(20, 2), nullable=False)
    close = Column(Numeric(20, 2), nullable=False)
    volume = Column(Numeric(30, 8), nullable=False)
    
    # æŠ€æœ¯æŒ‡æ ‡ï¼ˆé¢„è®¡ç®—ï¼‰
    ema_21 = Column(Numeric(20, 2))
    ema_55 = Column(Numeric(20, 2))
    rsi_14 = Column(Numeric(10, 2))
    macd = Column(Numeric(20, 2))
    macd_signal = Column(Numeric(20, 2))
    bb_upper = Column(Numeric(20, 2))
    bb_middle = Column(Numeric(20, 2))
    bb_lower = Column(Numeric(20, 2))
    
    # å…ƒæ•°æ®
    source = Column(String(50), default='binance')
    
    __table_args__ = (
        Index('idx_market_asset_time', 'asset', 'timeframe', 'timestamp'),
    )
```

**TimescaleDBé…ç½®**:
```sql
-- åˆ›å»ºHypertableï¼ˆåˆ†åŒºè¡¨ï¼‰
SELECT create_hypertable('market_data', 'timestamp', 
    chunk_time_interval => INTERVAL '1 day');

-- æ·»åŠ å‹ç¼©ç­–ç•¥ï¼ˆ7å¤©åå‹ç¼©ï¼‰
ALTER TABLE market_data SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'asset, timeframe'
);

SELECT add_compression_policy('market_data', INTERVAL '7 days');

-- æ•°æ®ä¿ç•™ç­–ç•¥ï¼ˆä¿ç•™1å¹´ï¼‰
SELECT add_retention_policy('market_data', INTERVAL '1 year');
```

### 3.2 agent_analysis_resultsï¼ˆAgentåˆ†æç»“æœè¡¨ï¼‰

**ç”¨é€”**: è®°å½•æ¯æ¬¡Agentåˆ†æçš„è¯¦ç»†ç»“æœ

```python
class AgentAnalysisResult(Base):
    __tablename__ = 'agent_analysis_results'
    
    # ä¸»é”®
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    timestamp = Column(DateTime, nullable=False, index=True)
    
    # å…³è”ä¿¡æ¯
    execution_id = Column(UUID(as_uuid=True), nullable=False)  # æœ¬æ¬¡æ‰§è¡ŒID
    strategy_id = Column(String(50), nullable=False)
    agent_type = Column(String(20), nullable=False)  # macro/onchain/ta
    
    # åˆ†æç»“æœ
    score = Column(Numeric(5, 2), nullable=False)  # -1.0 ~ +1.0
    confidence = Column(Numeric(5, 2), nullable=False)  # 0 ~ 1
    reasoning = Column(Text)
    
    # ç»†åˆ†ä¿¡å·ï¼ˆJSONï¼‰
    signals = Column(JSON)
    # ç¤ºä¾‹: {"etf_flow": "positive", "fed_rate": "dovish"}
    
    # æ€§èƒ½æŒ‡æ ‡
    execution_time_ms = Column(Integer)
    tokens_used = Column(Integer)
    llm_model = Column(String(50))
    llm_cost = Column(Numeric(10, 6))  # ç¾å…ƒ
    
    # è¾“å…¥æ•°æ®å¿«ç…§ï¼ˆå¯é€‰ï¼Œç”¨äºå›æº¯ï¼‰
    input_data = Column(JSON)
    
    __table_args__ = (
        Index('idx_agent_results_time', 'timestamp'),
        Index('idx_agent_results_exec', 'execution_id'),
        Index('idx_agent_results_strategy', 'strategy_id', 'timestamp'),
    )
```

**TimescaleDBé…ç½®**:
```sql
SELECT create_hypertable('agent_analysis_results', 'timestamp',
    chunk_time_interval => INTERVAL '7 days');

-- å‹ç¼©ç­–ç•¥ï¼ˆ30å¤©åï¼‰
ALTER TABLE agent_analysis_results SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'strategy_id, agent_type'
);
SELECT add_compression_policy('agent_analysis_results', INTERVAL '30 days');

-- ä¿ç•™2å¹´ï¼ˆç”¨äºç­–ç•¥ä¼˜åŒ–åˆ†æï¼‰
SELECT add_retention_policy('agent_analysis_results', INTERVAL '2 years');
```

### 3.3 strategy_executionsï¼ˆç­–ç•¥æ‰§è¡Œè®°å½•è¡¨ï¼‰

**ç”¨é€”**: è®°å½•æ¯æ¬¡ç­–ç•¥æ‰§è¡Œçš„å®Œæ•´è¿‡ç¨‹

```python
class StrategyExecution(Base):
    __tablename__ = 'strategy_executions'
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    timestamp = Column(DateTime, nullable=False, index=True)
    
    # ç­–ç•¥ä¿¡æ¯
    strategy_id = Column(String(50), nullable=False)
    user_id = Column(UUID(as_uuid=True), ForeignKey('users.id'))
    
    # å†³ç­–ç»“æœ
    conviction_score = Column(Numeric(5, 2), nullable=False)
    signal = Column(String(10), nullable=False)  # BUY/SELL/HOLD
    reasoning = Column(Text)
    
    # Agent Scoreæ±‡æ€»ï¼ˆJSONï¼‰
    agent_scores = Column(JSON)
    # ç¤ºä¾‹: {"macro": 0.8, "onchain": 0.7, "ta": 0.5}
    
    # æ‰§è¡Œç»“æœ
    action_taken = Column(String(20))  # executed/skipped/failed
    trade_id = Column(UUID(as_uuid=True), ForeignKey('trades.id'))
    
    # æ€§èƒ½
    total_execution_time_ms = Column(Integer)
    total_tokens_used = Column(Integer)
    total_cost = Column(Numeric(10, 6))
    
    # çŠ¶æ€
    status = Column(String(20), default='pending')
    error_message = Column(Text)
    
    __table_args__ = (
        Index('idx_executions_time', 'timestamp'),
        Index('idx_executions_strategy', 'strategy_id', 'timestamp'),
        Index('idx_executions_user', 'user_id', 'timestamp'),
    )
```

**TimescaleDBé…ç½®**:
```sql
SELECT create_hypertable('strategy_executions', 'timestamp',
    chunk_time_interval => INTERVAL '7 days');

ALTER TABLE strategy_executions SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'strategy_id'
);
SELECT add_compression_policy('strategy_executions', INTERVAL '30 days');
SELECT add_retention_policy('strategy_executions', INTERVAL '2 years');
```

---

## å››ã€æ•°æ®å…³ç³»å›¾

```
users (ç”¨æˆ·)
  â”œâ”€ 1:1 â†’ portfolios (æŠ•èµ„ç»„åˆ)
  â”‚         â”œâ”€ 1:N â†’ portfolio_holdings (æŒä»“)
  â”‚         â””â”€ 1:N â†’ trades (äº¤æ˜“è®°å½•)
  â”‚
  â”œâ”€ 1:N â†’ strategy_subscriptions (ç­–ç•¥è®¢é˜…)
  â”‚         â””â”€ N:1 â†’ strategies (ç­–ç•¥æ¨¡æ¿)
  â”‚
  â”œâ”€ 1:N â†’ strategy_executions (ç­–ç•¥æ‰§è¡Œ)
  â””â”€ 1:N â†’ sessions (ä¼šè¯)

strategies (ç­–ç•¥æ¨¡æ¿)
  â”œâ”€ 1:N â†’ strategy_subscriptions
  â”œâ”€ 1:N â†’ trades
  â””â”€ 1:N â†’ strategy_executions

market_data (å¸‚åœºæ•°æ® - TimescaleDB)
  â””â”€ æ—¶åºæ•°æ®ï¼Œæ— å¤–é”®å…³è”

agent_analysis_results (Agentç»“æœ - TimescaleDB)
  â””â”€ execution_id è½¯å…³è”åˆ° strategy_executions.id

strategy_executions (ç­–ç•¥æ‰§è¡Œ - TimescaleDB)
  â”œâ”€ N:1 â†’ strategies
  â”œâ”€ N:1 â†’ users
  â””â”€ 1:1 â†’ trades (å¯é€‰)
```

---

## äº”ã€ç´¢å¼•ç­–ç•¥

### 5.1 ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰

æ‰€æœ‰è¡¨çš„ä¸»é”®è‡ªåŠ¨åˆ›å»ºB-treeç´¢å¼•

### 5.2 å¤–é”®ç´¢å¼•ï¼ˆå¿…é¡»æ‰‹åŠ¨åˆ›å»ºï¼‰

```sql
-- ç”¨æˆ·ç›¸å…³
CREATE INDEX idx_sessions_user_id ON sessions(user_id);
CREATE INDEX idx_subscriptions_user_id ON strategy_subscriptions(user_id);
CREATE INDEX idx_portfolios_user_id ON portfolios(user_id);

-- äº¤æ˜“ç›¸å…³
CREATE INDEX idx_trades_user_id ON trades(user_id);
CREATE INDEX idx_trades_portfolio_id ON trades(portfolio_id);
CREATE INDEX idx_trades_strategy_id ON trades(strategy_id);
```

### 5.3 å¤åˆç´¢å¼•ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

```sql
-- é«˜é¢‘æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_trades_user_time ON trades(user_id, created_at DESC);
CREATE INDEX idx_executions_strategy_time ON strategy_executions(strategy_id, timestamp DESC);
CREATE INDEX idx_agent_results_exec_agent ON agent_analysis_results(execution_id, agent_type);

-- è¦†ç›–ç´¢å¼•ï¼ˆåŒ…å«å¸¸ç”¨æŸ¥è¯¢å­—æ®µï¼‰
CREATE INDEX idx_holdings_portfolio_asset_qty 
ON portfolio_holdings(portfolio_id, asset) 
INCLUDE (quantity, current_value);
```

### 5.4 éƒ¨åˆ†ç´¢å¼•ï¼ˆèŠ‚çœç©ºé—´ï¼‰

```sql
-- ä»…ç´¢å¼•æ´»è·ƒè®¢é˜…
CREATE INDEX idx_active_subscriptions 
ON strategy_subscriptions(user_id, strategy_id) 
WHERE status = 'active';

-- ä»…ç´¢å¼•å¾…æ‰§è¡Œäº¤æ˜“
CREATE INDEX idx_pending_trades 
ON trades(user_id, created_at) 
WHERE status = 'pending';
```

---

## å…­ã€æ•°æ®è¿ç§»ç­–ç•¥

### 6.1 Alembicè¿ç§»è„šæœ¬ç¤ºä¾‹

```python
# alembic/versions/001_initial_schema.py
def upgrade():
    # åˆ›å»ºç”¨æˆ·è¡¨
    op.create_table(
        'users',
        sa.Column('id', postgresql.UUID(), nullable=False),
        sa.Column('google_id', sa.String(255), nullable=False),
        sa.Column('email', sa.String(255), nullable=False),
        # ... å…¶ä»–å­—æ®µ
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('google_id'),
        sa.UniqueConstraint('email')
    )
    
    # åˆ›å»ºç´¢å¼•
    op.create_index('idx_users_email', 'users', ['email'])
    
    # ... å…¶ä»–è¡¨

def downgrade():
    op.drop_table('users')
```

### 6.2 è¿ç§»æœ€ä½³å®è·µ

1. **å‘åå…¼å®¹**: æ–°å¢å­—æ®µè®¾ç½®é»˜è®¤å€¼
2. **åˆ†æ­¥è¿ç§»**: å¤§è¡¨æ”¹åŠ¨åˆ†å¤šä¸ªç‰ˆæœ¬
3. **æ•°æ®æ ¡éªŒ**: è¿ç§»åè¿è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
4. **å›æ»šé¢„æ¡ˆ**: æ¯ä¸ªupgradeå¿…æœ‰å¯¹åº”downgrade

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 7.1 æŸ¥è¯¢ä¼˜åŒ–

**ä½¿ç”¨EXPLAIN ANALYZE**:
```sql
EXPLAIN ANALYZE
SELECT t.*, p.total_value 
FROM trades t
JOIN portfolios p ON t.portfolio_id = p.id
WHERE t.user_id = 'xxx'
ORDER BY t.created_at DESC
LIMIT 20;
```

**ä¼˜åŒ–æ–¹å‘**:
- ç¡®ä¿WHEREå­—æ®µæœ‰ç´¢å¼•
- ORDER BYå­—æ®µåŒ…å«åœ¨ç´¢å¼•ä¸­
- é¿å…SELECT *ï¼Œåªé€‰éœ€è¦çš„å­—æ®µ

### 7.2 è¿æ¥æ± é…ç½®

```python
# SQLAlchemyè¿æ¥æ± 
engine = create_async_engine(
    DATABASE_URL,
    pool_size=20,          # å¸¸é©»è¿æ¥æ•°
    max_overflow=10,       # æœ€å¤§æº¢å‡ºè¿æ¥
    pool_timeout=30,       # è·å–è¿æ¥è¶…æ—¶
    pool_recycle=3600,     # è¿æ¥å›æ”¶æ—¶é—´ï¼ˆ1å°æ—¶ï¼‰
    pool_pre_ping=True,    # è¿æ¥å‰pingæ£€æµ‹
    echo=False             # ç”Ÿäº§ç¯å¢ƒå…³é—­SQLæ—¥å¿—
)
```

### 7.3 æ‰¹é‡æ“ä½œ

```python
# âŒ é¿å…å¾ªç¯æ’å…¥
for data in market_data_list:
    await session.execute(insert(MarketData).values(data))

# âœ… æ‰¹é‡æ’å…¥
await session.execute(
    insert(MarketData),
    market_data_list
)
await session.commit()
```

---

## å…«ã€æ•°æ®å¤‡ä»½ä¸æ¢å¤

### 8.1 å¤‡ä»½ç­–ç•¥

| æ•°æ®ç±»å‹ | å¤‡ä»½é¢‘ç‡ | ä¿ç•™æ—¶é—´ | æ–¹å¼ |
|---------|---------|---------|------|
| ç”¨æˆ·æ•°æ® | æ¯6å°æ—¶ | 30å¤© | pg_dump |
| äº¤æ˜“è®°å½• | æ¯å¤© | æ°¸ä¹… | pg_dump |
| æ—¶åºæ•°æ® | æ¯å‘¨ | 1å¹´ | TimescaleDBå‹ç¼© |

### 8.2 å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups"

# å¤‡ä»½ä¸šåŠ¡æ•°æ®ï¼ˆæ’é™¤æ—¶åºè¡¨ï¼‰
pg_dump -h localhost -U postgres automoney \
  --exclude-table=market_data \
  --exclude-table=agent_analysis_results \
  --exclude-table=strategy_executions \
  -F c -f $BACKUP_DIR/automoney_$DATE.dump

# å‹ç¼©
gzip $BACKUP_DIR/automoney_$DATE.dump

# åˆ é™¤30å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.dump.gz" -mtime +30 -delete
```

### 8.3 æ¢å¤æµç¨‹

```bash
# æ¢å¤æ•°æ®åº“
pg_restore -h localhost -U postgres -d automoney_restored \
  /backups/automoney_20251105.dump.gz
```

---

## ä¹ã€ç›‘æ§æŒ‡æ ‡

### 9.1 æ•°æ®åº“æ€§èƒ½ç›‘æ§

```sql
-- æ…¢æŸ¥è¯¢ç›‘æ§ï¼ˆpg_stat_statementsï¼‰
SELECT query, calls, total_time, mean_time
FROM pg_stat_statements
WHERE mean_time > 1000  -- è¶…è¿‡1ç§’
ORDER BY total_time DESC
LIMIT 10;

-- è¡¨è†¨èƒ€æ£€æŸ¥
SELECT schemaname, tablename, 
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename))
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- ç´¢å¼•ä½¿ç”¨ç‡
SELECT schemaname, tablename, indexname, idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0  -- æœªä½¿ç”¨çš„ç´¢å¼•
ORDER BY pg_relation_size(indexrelid) DESC;
```

### 9.2 TimescaleDBç›‘æ§

```sql
-- ChunkçŠ¶æ€
SELECT * FROM timescaledb_information.chunks
WHERE hypertable_name = 'market_data';

-- å‹ç¼©ç‡
SELECT * FROM timescaledb_information.compression_settings;
```

---

## åã€å®‰å…¨æœ€ä½³å®è·µ

### 10.1 æ•°æ®åŠ å¯†

```sql
-- æ•æ„Ÿå­—æ®µåŠ å¯†ï¼ˆä½¿ç”¨pgcryptoæ‰©å±•ï¼‰
CREATE EXTENSION pgcrypto;

-- æ’å…¥æ—¶åŠ å¯†
INSERT INTO users (email, password_hash)
VALUES ('user@example.com', crypt('password', gen_salt('bf')));

-- éªŒè¯å¯†ç 
SELECT * FROM users 
WHERE email = 'user@example.com' 
AND password_hash = crypt('input_password', password_hash);
```

### 10.2 æƒé™æ§åˆ¶

```sql
-- åˆ›å»ºåªè¯»ç”¨æˆ·ï¼ˆç”¨äºæŠ¥è¡¨æŸ¥è¯¢ï¼‰
CREATE USER readonly_user WITH PASSWORD 'xxx';
GRANT CONNECT ON DATABASE automoney TO readonly_user;
GRANT USAGE ON SCHEMA public TO readonly_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

-- åˆ›å»ºåº”ç”¨ç”¨æˆ·ï¼ˆè¯»å†™æƒé™ï¼‰
CREATE USER app_user WITH PASSWORD 'xxx';
GRANT CONNECT ON DATABASE automoney TO app_user;
GRANT USAGE, CREATE ON SCHEMA public TO app_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;
```

### 10.3 SQLæ³¨å…¥é˜²æŠ¤

```python
# âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
result = await session.execute(
    select(User).where(User.email == user_email)
)

# âŒ é¿å…å­—ç¬¦ä¸²æ‹¼æ¥
query = f"SELECT * FROM users WHERE email = '{user_email}'"  # å±é™©ï¼
```

---

## åä¸€ã€å¼€å‘ç¯å¢ƒå¿«é€Ÿå¯åŠ¨

### 11.1 Docker Composeé…ç½®

```yaml
version: '3.8'

services:
  postgres:
    image: timescale/timescaledb:latest-pg16
    environment:
      POSTGRES_DB: automoney
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### 11.2 åˆå§‹åŒ–è„šæœ¬

```sql
-- init.sql
CREATE EXTENSION IF NOT EXISTS timescaledb;
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- åˆ›å»ºåº”ç”¨ç”¨æˆ·
CREATE USER app_user WITH PASSWORD 'dev_password';
GRANT ALL PRIVILEGES ON DATABASE automoney TO app_user;
```

---

**ğŸ“Œ å…³é”®Takeaway**: 
- PostgreSQL + TimescaleDBåˆ†ç¦»ä¸šåŠ¡ä¸æ—¶åºæ•°æ®
- åˆç†çš„ç´¢å¼•ç­–ç•¥æå‡æŸ¥è¯¢æ€§èƒ½
- Alembicç®¡ç†æ•°æ®åº“ç‰ˆæœ¬
- å®Œå–„çš„å¤‡ä»½ä¸ç›‘æ§æœºåˆ¶

**ä¸‹ä¸€æ­¥**: é˜…è¯» `06-éƒ¨ç½²ä¸è¿ç»´æ–¹æ¡ˆ.md` äº†è§£éƒ¨ç½²æµç¨‹

