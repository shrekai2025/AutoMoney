# ç³»ç»Ÿæ¶æ„ä¿®å¤å®ŒæˆæŠ¥å‘Š

## âœ… ä¿®å¤å†…å®¹

æˆåŠŸä¿®å¤äº†**è°ƒåº¦å™¨ç¡¬ç¼–ç Agentæ‰§è¡Œ**çš„æ ¸å¿ƒæ¶æ„é—®é¢˜ã€‚

---

## ğŸ› é—®é¢˜å›é¡¾

### ç—‡çŠ¶
åŠ¨é‡ç­–ç•¥åœ¨å®šæ—¶æ‰§è¡Œæ—¶,UIæ˜¾ç¤ºæ—§çš„3ä¸ªAgent(Macro Scout/Chain Guardian/Momentum Scout),è€Œä¸æ˜¯åº”è¯¥çš„2ä¸ªæ–°Agent(Regime Filter/Momentum TA)ã€‚

### æ ¹æœ¬åŸå› 
**Schedulerçš„`batch_execute_by_template`æ–¹æ³•ç¡¬ç¼–ç äº†`RealAgentExecutor`**,å¯¼è‡´:
1. æ‰€æœ‰ç­–ç•¥éƒ½æ‰§è¡Œæ—§çš„3ä¸ªAgent(macro/ta/onchain)
2. å®Œå…¨å¿½ç•¥`strategy_definition.business_agents`é…ç½®
3. åŠ¨é‡ç­–ç•¥çš„æ–°Agent(regime_filter/ta_momentum)ä»æœªè¢«è°ƒåº¦å™¨æ‰§è¡Œ

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶: `AMbackend/app/services/strategy/scheduler.py`

#### ä¿®å¤å‰ (ç¬¬392-401è¡Œ)
```python
# 4. æ‰§è¡Œä¸€æ¬¡Agentåˆ†æï¼ˆæ‰€æœ‰å®ä¾‹å…±äº«ï¼‰
from app.services.strategy.real_agent_executor import RealAgentExecutor
agent_executor = RealAgentExecutor()  # âŒ ç¡¬ç¼–ç 

agent_outputs, agent_errors = await agent_executor.execute_all_agents(  # âŒ æ€»æ˜¯æ‰§è¡Œmacro/ta/onchain
    market_data=market_data,
    db=db,
    user_id=portfolios[0].user_id,
    strategy_execution_id=None,
    template_execution_batch_id=batch_id,
)
```

#### ä¿®å¤å
```python
# 4. æ ¹æ®ç­–ç•¥å®šä¹‰åŠ¨æ€æ‰§è¡ŒAgentåˆ†æï¼ˆæ‰€æœ‰å®ä¾‹å…±äº«ï¼‰
# ğŸ†• æ ¹æ®ç­–ç•¥å®šä¹‰é€‰æ‹©Agentæ‰§è¡Œå™¨
if definition.business_agents:
    # ä½¿ç”¨åŠ¨æ€Agentæ‰§è¡Œå™¨(æ–°ç­–ç•¥)
    from app.services.strategy.dynamic_agent_executor import dynamic_agent_executor
    
    logger.info(f"ä½¿ç”¨åŠ¨æ€Agentæ‰§è¡Œå™¨: {definition.business_agents}")
    agent_outputs, agent_errors = await dynamic_agent_executor.execute_agents(
        agent_names=definition.business_agents,  # âœ… ä»ç­–ç•¥å®šä¹‰è¯»å–
        market_data=market_data,
        db=db,
        user_id=portfolios[0].user_id,
        strategy_execution_id=None,
        template_execution_batch_id=batch_id,
    )
    logger.info(f"âœ… åŠ¨æ€Agentæ‰§è¡Œå®Œæˆ: {list(agent_outputs.keys())}")
else:
    # ä½¿ç”¨é»˜è®¤Agentæ‰§è¡Œå™¨(æ—§ç­–ç•¥,å‘åå…¼å®¹)
    from app.services.strategy.real_agent_executor import RealAgentExecutor
    agent_executor = RealAgentExecutor()
    
    logger.info("ä½¿ç”¨é»˜è®¤Agentæ‰§è¡Œå™¨(æ—§ç­–ç•¥)")
    agent_outputs, agent_errors = await agent_executor.execute_all_agents(
        market_data=market_data,
        db=db,
        user_id=portfolios[0].user_id,
        strategy_execution_id=None,
        template_execution_batch_id=batch_id,
    )
    logger.info(f"âœ… é»˜è®¤Agentæ‰§è¡Œå®Œæˆ")
```

---

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. é…ç½®é©±åŠ¨
- âœ… è¯»å–`strategy_definition.business_agents`
- âœ… æ ¹æ®é…ç½®é€‰æ‹©æ‰§è¡Œå™¨
- âœ… ä¸å†ç¡¬ç¼–ç Agentç»„åˆ

### 2. åŠ¨æ€è°ƒåº¦
- âœ… æœ‰`business_agents`é…ç½® â†’ ä½¿ç”¨`DynamicAgentExecutor`
- âœ… æ— `business_agents`é…ç½® â†’ ä½¿ç”¨`RealAgentExecutor`(å‘åå…¼å®¹)

### 3. å‘åå…¼å®¹
- âœ… æ—§ç­–ç•¥å·²æœ‰é…ç½®: `['macro', 'ta', 'onchain']`
- âœ… æ–°ç­–ç•¥å·²æœ‰é…ç½®: `['regime_filter', 'ta_momentum']`
- âœ… ä¸¤ç§ç­–ç•¥éƒ½èƒ½æ­£å¸¸å·¥ä½œ

---

## ğŸ“Š æ‰§è¡Œæµç¨‹å¯¹æ¯”

### ä¿®å¤å‰ âŒ
```
è°ƒåº¦å™¨ (æ¯15åˆ†é’Ÿ)
  â†“
batch_execute_by_template
  â†“
ç¡¬ç¼–ç : RealAgentExecutor
  â†“
æ€»æ˜¯æ‰§è¡Œ: macro/ta/onchain
  â†“
åŠ¨é‡ç­–ç•¥ä¹Ÿä½¿ç”¨æ—§Agentç»“æœ âŒ
  â†“
UIæ˜¾ç¤º: Macro Scout/Chain Guardian/Momentum Scout âŒ
```

### ä¿®å¤å âœ…
```
è°ƒåº¦å™¨ (æ¯15åˆ†é’Ÿ)
  â†“
batch_execute_by_template
  â†“
è¯»å–: definition.business_agents
  â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â†“                             â†“
æ—§ç­–ç•¥                          åŠ¨é‡ç­–ç•¥
['macro',                       ['regime_filter',
 'ta',                           'ta_momentum']
 'onchain']
   â†“                             â†“
RealAgentExecutor              DynamicAgentExecutor
   â†“                             â†“
æ‰§è¡Œmacro/ta/onchain âœ…         æ‰§è¡Œregime_filter/ta_momentum âœ…
   â†“                             â†“
æ—§ç­–ç•¥ä½¿ç”¨æ—§Agent âœ…             åŠ¨é‡ç­–ç•¥ä½¿ç”¨æ–°Agent âœ…
   â†“                             â†“
UIæ˜¾ç¤º3ä¸ªæ—§Agent âœ…              UIæ˜¾ç¤º2ä¸ªæ–°Agent âœ…
```

---

## âœ… éªŒè¯ç»“æœ

### ç­–ç•¥é…ç½®ç¡®è®¤
```
ç­–ç•¥æ¨¡æ¿é…ç½®:
================================================================================
ID: 1
  Name: multi_agent_btc_v1
  Display: Multi-Agent BTC Strategy
  Business Agents: ['macro', 'ta', 'onchain']  âœ…
  Decision Agent: MultiAgentConvictionDecision
  Rebalance Period: 10 min
--------------------------------------------------------------------------------
ID: 3
  Name: momentum_regime_btc_v1
  Display: H.I.M.E. åŠ¨é‡ç­–ç•¥
  Business Agents: ['regime_filter', 'ta_momentum']  âœ…
  Decision Agent: MomentumRegimeDecision
  Rebalance Period: 15 min
--------------------------------------------------------------------------------
```

### é¢„æœŸæ‰§è¡Œç»“æœ

#### æ—§ç­–ç•¥ (multi_agent_btc_v1)
```
å®šæ—¶æ‰§è¡Œ
  â†’ è¯»å–business_agents: ['macro', 'ta', 'onchain']
  â†’ ä½¿ç”¨RealAgentExecutor
  â†’ æ‰§è¡Œmacro_agent, ta_agent, onchain_agent
  â†’ ä¿å­˜3ä¸ªAgentæ‰§è¡Œè®°å½•
  â†’ UIæ˜¾ç¤º: The Oracle, Momentum Scout, Data Warden âœ…
```

#### åŠ¨é‡ç­–ç•¥ (momentum_regime_btc_v1)
```
å®šæ—¶æ‰§è¡Œ
  â†’ è¯»å–business_agents: ['regime_filter', 'ta_momentum']
  â†’ ä½¿ç”¨DynamicAgentExecutor
  â†’ æ‰§è¡Œregime_filter_agent, ta_momentum_agent
  â†’ ä¿å­˜2ä¸ªAgentæ‰§è¡Œè®°å½•
  â†’ UIæ˜¾ç¤º: Regime Filter, Momentum TA âœ…
  â†’ æ˜¾ç¤ºRegime Scoreå¥åº·æ¡ âœ…
  â†’ æ˜¾ç¤ºOCOè®¢å•(å¦‚æœæœ‰äº¤æ˜“) âœ…
```

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

### è‡ªåŠ¨æµ‹è¯• (å®šæ—¶è°ƒåº¦)
1. ç­‰å¾…15åˆ†é’Ÿ,è°ƒåº¦å™¨è‡ªåŠ¨æ‰§è¡ŒåŠ¨é‡ç­–ç•¥
2. æŸ¥çœ‹åç«¯æ—¥å¿—:
```bash
tail -f /Users/uniteyoo/Documents/AutoMoney/.pids/backend.log
```

åº”è¯¥çœ‹åˆ°:
```
æ‰§è¡Œç­–ç•¥æ¨¡æ¿: H.I.M.E. åŠ¨é‡ç­–ç•¥ (ID=3)
ä¸šåŠ¡Agent: ['regime_filter', 'ta_momentum']
ä½¿ç”¨åŠ¨æ€Agentæ‰§è¡Œå™¨: ['regime_filter', 'ta_momentum']
å¼€å§‹æ‰§è¡Œ regime_filter...
âœ… regime_filter æ‰§è¡Œå®Œæˆ
âœ… regime_filter æ‰§è¡Œè®°å½•å·²ä¿å­˜
å¼€å§‹æ‰§è¡Œ ta_momentum...
âœ… ta_momentum æ‰§è¡Œå®Œæˆ
âœ… ta_momentum æ‰§è¡Œè®°å½•å·²ä¿å­˜
âœ… åŠ¨æ€Agentæ‰§è¡Œå®Œæˆ: dict_keys(['regime_filter', 'ta_momentum'])
```

### æ‰‹åŠ¨æµ‹è¯•
1. åœ¨UIä¸­ç‚¹å‡»åŠ¨é‡ç­–ç•¥çš„"Execute Now"æŒ‰é’®
2. æŸ¥çœ‹ç­–ç•¥è¯¦æƒ…é¡µçš„"Recent Squad Actions"
3. åº”è¯¥æ˜¾ç¤º: 
   - **Regime Filter** (è“è‰²ç‚¹)
   - **Momentum TA** (ç´«è‰²ç‚¹)
   - Regime Scoreå¥åº·æ¡
   - (å¦‚æœæœ‰äº¤æ˜“)OCOè®¢å•è¯¦æƒ…

---

## ğŸ“ˆ ç³»ç»Ÿæ¶æ„æ”¹è¿›

### Before (ç¡¬ç¼–ç )
```
Scheduler â†’ ç¡¬ç¼–ç RealAgentExecutor â†’ å›ºå®š3ä¸ªAgent
```

### After (é…ç½®é©±åŠ¨)
```
Scheduler â†’ è¯»å–business_agents â†’ åŠ¨æ€é€‰æ‹©Executor â†’ æ­£ç¡®çš„Agentç»„åˆ
```

### è®¾è®¡åŸåˆ™
1. **é…ç½®ä¼˜äºç¡¬ç¼–ç **: æ‰€æœ‰ç­–ç•¥è¡Œä¸ºç”±StrategyDefinitionå®šä¹‰
2. **è§£è€¦åˆ**: Schedulerä¸çŸ¥é“å…·ä½“Agentå®ç°
3. **å¯æ‰©å±•**: æ–°å¢ç­–ç•¥æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
4. **å‘åå…¼å®¹**: æ—§ç­–ç•¥ç»§ç»­æ­£å¸¸å·¥ä½œ

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. åˆ†å±‚æ¶æ„çš„é‡è¦æ€§
```
è°ƒåº¦å±‚ â†’ ç¼–æ’å±‚ â†’ æ‰§è¡Œå±‚ â†’ ä¸šåŠ¡å±‚ â†’ å†³ç­–å±‚
```
æ¯ä¸€å±‚éƒ½åº”è¯¥é€šè¿‡é…ç½®è€Œéç¡¬ç¼–ç æ¥åä½œã€‚

### 2. æ‰¹é‡ä¼˜åŒ–çš„è¾¹ç•Œ
- âœ… å¯ä»¥å…±äº«: å¸‚åœºæ•°æ®é‡‡é›†
- âœ… å¯ä»¥å…±äº«: åŒä¸€æ¨¡æ¿çš„Agentç»“æœ
- âŒ ä¸èƒ½å…±äº«: ä¸åŒæ¨¡æ¿çš„Agentç»“æœ

### 3. å¤šè·¯å¾„æ‰§è¡Œçš„ä¸€è‡´æ€§
- APIæ‰‹åŠ¨è§¦å‘
- è°ƒåº¦å™¨å®šæ—¶è§¦å‘
- CLIè„šæœ¬è§¦å‘

**æ‰€æœ‰è·¯å¾„éƒ½åº”è¯¥ä½¿ç”¨ç›¸åŒçš„é€»è¾‘!**

### 4. æµ‹è¯•è¦†ç›–çš„é‡è¦æ€§
- å•å…ƒæµ‹è¯• âœ… (å„ç»„ä»¶ç‹¬ç«‹å·¥ä½œ)
- é›†æˆæµ‹è¯• âœ… (å®Œæ•´æµç¨‹éªŒè¯)
- **ç«¯åˆ°ç«¯æµ‹è¯•** âš ï¸ (ç¼ºå¤±å¯¼è‡´æœªå‘ç°æ­¤bug)

---

## ğŸ“‹ ç›¸å…³ä¿®å¤å†å²

### ä¹‹å‰çš„ä¿®å¤
1. âœ… API endpointä¸å†ç¡¬ç¼–ç Agent (ç¬¬ä¸€æ¬¡ä¿®å¤)
2. âœ… Agentæ‰§è¡Œè®°å½•ä¿å­˜ (æ·»åŠ record_generic_agent)
3. âœ… DecisionOutputç±»å‹å…¼å®¹
4. âœ… OnChainAgentå¯¼å…¥ä¿®å¤
5. âœ… ç­–ç•¥æ„ŸçŸ¥UI (åŠ¨æ€å±•ç¤ºä¸åŒUI)

### æœ¬æ¬¡ä¿®å¤
6. âœ… **ScheduleråŠ¨æ€Agentæ‰§è¡Œ** (æœ€åä¸€å—æ‹¼å›¾)

---

## âœ… æ€»ç»“

### é—®é¢˜æ ¹æº
è°ƒåº¦å™¨ç¡¬ç¼–ç `RealAgentExecutor`,å¿½ç•¥ç­–ç•¥é…ç½®ã€‚

### è§£å†³æ–¹æ¡ˆ
æ ¹æ®`business_agents`åŠ¨æ€é€‰æ‹©Executor,å‘åå…¼å®¹ã€‚

### å½±å“èŒƒå›´
- æ‰€æœ‰å®šæ—¶æ‰§è¡Œçš„ç­–ç•¥
- åŠ¨é‡ç­–ç•¥ç°åœ¨èƒ½æ­£ç¡®æ‰§è¡Œæ–°Agent
- æ—§ç­–ç•¥ç»§ç»­æ­£å¸¸å·¥ä½œ

### æ¶æ„æ”¹è¿›
- é…ç½®é©±åŠ¨è®¾è®¡
- è§£è€¦åˆæ‰§è¡Œå±‚
- å®Œå…¨å¯æ‰©å±•

---

**ä¿®å¤çŠ¶æ€**: âœ… å®Œæˆ  
**éƒ¨ç½²çŠ¶æ€**: âœ… åç«¯å·²é‡å¯  
**æµ‹è¯•çŠ¶æ€**: â³ ç­‰å¾…ä¸‹æ¬¡å®šæ—¶æ‰§è¡Œ(15åˆ†é’Ÿå†…)  
**é¢„æœŸæ•ˆæœ**: åŠ¨é‡ç­–ç•¥æ˜¾ç¤ºRegime Filter + Momentum TA

